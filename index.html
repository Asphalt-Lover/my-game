<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBONDS: Орбитальный Бэклог</title>
  <style>
    :root{
      --bg0:#07070a; --bg1:#0b0d12; --ink:#e9eef7; --muted:rgba(233,238,247,.68);
      --glass: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.22);
      --danger: rgba(255,120,120,.95);
      --ok: rgba(120,255,190,.95);
      --warn: rgba(255,205,120,.95);
      --radius: 18px;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% 10%, #14183b 0%, transparent 55%),
                  radial-gradient(900px 700px at 70% 30%, #2a1440 0%, transparent 60%),
                  radial-gradient(800px 600px at 30% 80%, #0c3b2a 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--ink);
      overflow-x:hidden;
    }
    .bg-drift{
      position:fixed; inset:-30%;
      background:
        radial-gradient(900px 600px at 20% 35%, rgba(138,115,255,.20), transparent 58%),
        radial-gradient(850px 700px at 75% 30%, rgba(255,120,200,.12), transparent 60%),
        radial-gradient(800px 620px at 45% 80%, rgba(110,255,210,.10), transparent 55%);
      filter: blur(18px) saturate(1.12);
      animation: drift 18s ease-in-out infinite alternate;
      opacity:.9;
      pointer-events:none;
    }
    @keyframes drift{
      0%{ transform: translate3d(-2%, -1%, 0) scale(1.02) rotate(-.5deg); }
      100%{ transform: translate3d(2%, 1.5%, 0) scale(1.06) rotate(.6deg); }
    }
    .grain{
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.18;
      pointer-events:none;
    }
    .wrap{ max-width: 1100px; margin: 0 auto; padding: 22px 16px 44px; position:relative; }
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      position:sticky; top:0; z-index:4;
      padding: 12px 10px;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(8,9,14,.78), rgba(8,9,14,.38));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: 0 10px 40px rgba(0,0,0,.28);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width: 240px; }
    .logo{
      width:34px; height:34px; border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.28), rgba(255,255,255,.06)),
                  linear-gradient(135deg, rgba(170,120,255,.55), rgba(120,255,210,.25));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
      position:relative; overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-30%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
      transform: rotate(25deg);
      animation: shine 3.6s ease-in-out infinite;
      opacity:.7;
    }
    @keyframes shine{
      0%{ transform: translateX(-35%) rotate(25deg); opacity:.0; }
      25%{ opacity:.7; }
      55%{ opacity:.6; }
      100%{ transform: translateX(35%) rotate(25deg); opacity:.0; }
    }
    h1{ margin:0; font-size: 14px; letter-spacing:.2px; font-weight:800; }
    .subtitle{ font-size: 12px; color: var(--muted); margin-top:2px; }
    .top-right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(233,238,247,.86);
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.25); }
    .dot.ok{ background: rgba(120,255,190,.85); }
    .dot.warn{ background: rgba(255,205,120,.85); }
    .dot.bad{ background: rgba(255,120,120,.85); }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card-inner{ padding: 16px 16px 14px; }

    .scene-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom: 8px;
    }
    .scene-title{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .badge{
      font-size: 11px;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: rgba(233,238,247,.8);
      white-space:nowrap;
    }
    .scene-text{
      margin: 0;
      line-height: 1.62;
      color: rgba(233,238,247,.93);
      white-space: pre-wrap;
      min-height: 120px;
    }
    .whisper{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      color: rgba(233,238,247,.70);
      font-style: italic;
      font-size: 13px;
    }
    .choices{ display:grid; gap:10px; margin-top: 14px; }
    button.choice{
      cursor:pointer;
      text-align:left;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color: rgba(233,238,247,.96);
      padding: 12px 12px;
      font-size: 14px;
      transition: transform .05s ease, border-color .12s ease, background .12s ease, filter .12s ease;
      position:relative;
      overflow:hidden;
    }
    button.choice:hover{
      border-color: rgba(255,255,255,.26);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
      filter: brightness(1.03);
    }
    button.choice:active{ transform: translateY(1px); }
    .choice-meta{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(233,238,247,.62);
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tag{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      padding: 2px 8px;
      border-radius: 999px;
    }
    .tag.bad{ border-color: rgba(255,120,120,.30); color: rgba(255,160,160,.92); }
    .tag.warn{ border-color: rgba(255,205,120,.30); color: rgba(255,205,120,.92); }
    .tag.ok{ border-color: rgba(120,255,190,.30); color: rgba(140,255,210,.92); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
    .ghost{
      cursor:pointer;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: transparent;
      color: rgba(233,238,247,.86);
      padding: 10px 12px;
      font-size: 13px;
    }
    .ghost:hover{ border-color: rgba(255,255,255,.30); background: rgba(255,255,255,.03); }
    .ghost:disabled{ opacity:.45; cursor:not-allowed; }

    .panel-title{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin:0 0 10px;
    }
    .panel-title h2{ margin:0; font-size: 13px; font-weight: 900; letter-spacing:.25px; color: rgba(233,238,247,.86); }
    .tiny{ font-size: 12px; color: rgba(233,238,247,.62); }

    .meter{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 10px 10px;
      margin-bottom: 12px;
    }
    .meter-top{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .bar{
      height: 10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      margin-top: 10px;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(120,255,190,.85), rgba(255,205,120,.85), rgba(255,120,120,.85));
      transition: width .35s ease;
    }

    .kv{
      display:grid; grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .k{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px 10px;
      min-height: 52px;
    }
    .k .lbl{ font-size: 11px; color: rgba(233,238,247,.62); }
    .k .val{ font-size: 14px; font-weight: 900; margin-top: 2px; }

    details{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px 10px;
      margin-top: 12px;
    }
    summary{
      cursor:pointer;
      font-weight: 800;
      font-size: 12px;
      color: rgba(233,238,247,.86);
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .log{
      margin-top:10px;
      display:grid; gap:8px;
      max-height: 240px;
      overflow:auto;
      padding-right:6px;
    }
    .log-item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      border-radius: 14px;
      padding: 10px 10px;
      font-size: 12px;
      color: rgba(233,238,247,.82);
    }
    .log-item .t{ color: rgba(233,238,247,.62); font-size: 11px; margin-top: 4px; }

    .map{
      margin-top: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px 10px;
    }
    .dots{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
    .p{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .p.on{ background: rgba(120,255,190,.35); border-color: rgba(120,255,190,.45); }
    .p.bad{ background: rgba(255,120,120,.25); border-color: rgba(255,120,120,.45); }

    .art{
      height: 120px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(700px 220px at 30% 30%, rgba(255,255,255,.10), transparent 65%),
        linear-gradient(135deg, rgba(170,120,255,.22), rgba(120,255,210,.10));
      position:relative;
      overflow:hidden;
    }
    .art svg{ position:absolute; inset:0; width:100%; height:100%; opacity:.85; }
    .art .glow{
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 35%, rgba(255,255,255,.12), transparent 55%);
      filter: blur(20px);
      animation: drift2 14s ease-in-out infinite alternate;
    }
    @keyframes drift2{ from{ transform: translate(-1%, 1%) scale(1.02); } to{ transform: translate(2%, -1%) scale(1.06); } }

    .glitch{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:0;
      background:
        linear-gradient(90deg, rgba(255,60,160,.12), transparent 24%, rgba(80,255,210,.10) 55%, transparent 75%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.06) 0 1px, transparent 1px 3px);
      mix-blend-mode: screen;
      transform: translateZ(0);
    }
    .glitch.on{ animation: glitch 420ms linear 1; }
    @keyframes glitch{
      0%{ opacity:0; transform: translate(0,0); }
      15%{ opacity:.55; transform: translate(8px,-6px) skewX(2deg); }
      35%{ opacity:.35; transform: translate(-10px,4px) skewX(-2deg); }
      55%{ opacity:.45; transform: translate(6px,8px) skewY(1deg); }
      100%{ opacity:0; transform: translate(0,0); }
    }

    /* Start overlay */
    .overlay{
      position:fixed; inset:0; z-index:10;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.52);
      backdrop-filter: blur(10px);
      padding: 18px;
    }
    .overlay .modal{
      width:min(820px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(14,14,20,.78);
      box-shadow: 0 30px 120px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .overlay .modal .top{
      padding: 16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .overlay .modal .top .t1{ font-weight: 950; letter-spacing:.2px; }
    .overlay .modal .top .t2{ color: rgba(233,238,247,.65); font-size: 12px; margin-top:4px; }
    .overlay .modal .body{ padding: 14px 16px 16px; }
    .overlay .grid2{ display:grid; grid-template-columns: 1.1fr .9fr; gap:12px; }
    @media (max-width: 860px){ .overlay .grid2{ grid-template-columns: 1fr; } }
    .overlay .box{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding: 12px 12px;
    }
    .overlay .box h3{ margin:0 0 8px; font-size: 13px; font-weight: 950; color: rgba(233,238,247,.88); }
    .overlay .box p{ margin:0; font-size: 12px; line-height:1.6; color: rgba(233,238,247,.72); }
    .overlay .actions{ display:grid; gap:10px; margin-top: 12px; }
    .overlay .small{ margin-top:10px; font-size:12px; color: rgba(233,238,247,.62); }
    a{ color:#9ad0ff; }
    code{ color: rgba(233,238,247,.85); }
  </style>
</head>
<body>
  <div class="bg-drift"></div>
  <div class="grain"></div>
  <div class="glitch" id="glitch"></div>

  <!-- Start / Continue overlay -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="top">
        <div>
          <div class="t1">CBONDS: Орбитальный Бэклог</div>
          <div class="t2">Космический симулятор продуктовых решений: Совет → техком → анализ → спринт → dev → prod</div>
        </div>
        <div class="tiny">
          <label style="display:inline-flex; gap:8px; align-items:center; cursor:pointer;">
            <input type="checkbox" id="audioToggle2" checked />
            звук
          </label>
          &nbsp;·&nbsp;
          <label style="display:inline-flex; gap:8px; align-items:center; cursor:pointer;">
            <input type="checkbox" id="typeToggle2" checked />
            печать
          </label>
        </div>
      </div>
      <div class="body">
        <div class="grid2">
          <div class="box">
            <h3>Как играть</h3>
            <p>
              Вы выбираете, как провести клиентский запрос через процессы Cbonds.<br>
              Есть скрытые ответы по условиям (фокус/стресс/репутация/флаги).<br>
              На техкоме вас ждёт мини-защита “что/зачем/почему сейчас”.
            </p>
            <div class="actions">
              <button class="choice" id="btnNew">Новая миссия</button>
              <button class="choice" id="btnContinue">Продолжить миссию</button>
              <button class="choice" id="btnResetSave">Стереть сохранение</button>
            </div>
            <div class="small">Сохранение идёт автоматически после каждого выбора.</div>
          </div>
          <div class="box">
            <h3>Параметры</h3>
            <p>
              <b>Фокус</b> — ясность и энергия. Мало фокуса → ответы закрываются, а хаос растёт.<br>
              <b>Стресс + Скоуп</b> разгоняют Creep-meter и вероятность “немедленных задач”.<br>
              <b>Репутация</b> помогает на Совете/техкоме.
            </p>
            <div class="small">Совет командования и техком — “точки решений”. Дальше работает конвейер.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="gameTitle">CBONDS: Орбитальный Бэклог</h1>
          <div class="subtitle" id="gameSub">космическая история про фидбэк и спринты</div>
        </div>
      </div>

      <div class="top-right">
        <div class="pill" id="pillRole"><span class="dot"></span><span>Роль: <b id="stRole">—</b></span></div>
        <div class="pill" id="pillDay"><span class="dot"></span><span>День: <b id="stDay">1</b></span></div>
        <div class="pill" id="pillBudget"><span class="dot"></span><span>Бюджет: <b id="stBudget">100</b></span></div>
        <div class="pill" id="pillStress"><span class="dot"></span><span>Стресс: <b id="stStress">0</b></span></div>
        <div class="pill" id="pillScope"><span class="dot"></span><span>Скоуп: <b id="stScope">1</b></span></div>
        <div class="pill"><span class="dot"></span><span>Фокус: <b id="stFocus">100</b></span></div>
      </div>
    </header>

    <div class="grid">
      <section class="card" id="mainCard">
        <div class="art">
          <div class="glow"></div>
          <svg viewBox="0 0 1200 240" preserveAspectRatio="none" aria-hidden="true">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="rgba(255,255,255,.20)"/>
                <stop offset="1" stop-color="rgba(255,255,255,0)"/>
              </linearGradient>
              <filter id="blur">
                <feGaussianBlur stdDeviation="4"/>
              </filter>
            </defs>
            <path d="M0,180 C140,120 260,210 420,150 C580,90 690,200 860,140 C1020,90 1120,160 1200,120 L1200,240 L0,240 Z"
                  fill="rgba(0,0,0,.18)"/>
            <path d="M0,150 C150,100 280,210 440,150 C610,85 730,210 900,140 C1050,95 1140,130 1200,95"
                  stroke="rgba(255,255,255,.22)" stroke-width="2" fill="none"/>
            <g filter="url(#blur)" opacity=".85">
              <circle cx="180" cy="90" r="22" fill="url(#g1)"/>
              <circle cx="520" cy="70" r="28" fill="url(#g1)"/>
              <circle cx="860" cy="82" r="24" fill="url(#g1)"/>
            </g>
          </svg>
        </div>

        <div class="card-inner">
          <div class="scene-head">
            <div>
              <h2 class="scene-title" id="nodeTitle">Загрузка…</h2>
              <div class="tiny" id="nodeMeta"></div>
            </div>
            <div class="badge" id="nodeBadge">—</div>
          </div>

          <p class="scene-text" id="nodeText"></p>
          <div class="whisper" id="whisper" hidden></div>

          <div class="choices" id="choices"></div>

          <div class="row">
            <button class="ghost" id="restartBtn" type="button">Новая миссия</button>
            <button class="ghost" id="continueBtn" type="button">Продолжить</button>
            <button class="ghost" id="backBtn" type="button" disabled>Шаг назад</button>
            <button class="ghost" id="skipBtn" type="button">Пропустить печать</button>
          </div>

          <div class="tiny" style="margin-top:10px;">
            Редактирование: все сцены и ветки лежат в объекте <code>story</code>.
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="card-inner">
          <div class="panel-title">
            <h2>Панель станции</h2>
            <div class="tiny">
              <label style="display:inline-flex; gap:8px; align-items:center; cursor:pointer;">
                <input type="checkbox" id="audioToggle" checked />
                звук
              </label>
              &nbsp;·&nbsp;
              <label style="display:inline-flex; gap:8px; align-items:center; cursor:pointer;">
                <input type="checkbox" id="typeToggle" checked />
                печать
              </label>
            </div>
          </div>

          <div class="meter">
            <div class="meter-top">
              <div style="font-weight:900;">Creep-meter</div>
              <div class="tiny" id="creepLabel">спокоен</div>
            </div>
            <div class="bar"><div id="creepBar"></div></div>
            <div class="tiny" id="creepHint" style="margin-top:8px;">
              Стресс + скоуп + низкий фокус повышают “шум космоса”.
            </div>
          </div>

          <div class="kv">
            <div class="k">
              <div class="lbl">Риск срыва</div>
              <div class="val" id="riskVal">низкий</div>
            </div>
            <div class="k">
              <div class="lbl">Репутация</div>
              <div class="val" id="repVal">ровная</div>
            </div>
          </div>

          <div class="map">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <div style="font-weight:900; font-size:12px;">Прогресс миссии</div>
              <div class="tiny"><span id="stepsNow">0</span>/<span id="stepsMax">18</span></div>
            </div>
            <div class="dots" id="dots"></div>
          </div>

          <details open>
            <summary>Журнал решений</summary>
            <div class="log" id="log"></div>
          </details>

          <details>
            <summary>Направление исполнения</summary>
            <div class="tiny" id="deptHint" style="margin-top:10px; line-height:1.6;">
              Подразделение ещё не назначено.
            </div>
          </details>
        </div>
      </aside>
    </div>
  </div>

<script>
/** ======================
 *  STORY (Cbonds + космос)
 *  Включено:
 *  - выбор роли (Продажи / Database / PO-координатор)
 *  - ветки по направлениям (front/back/data/design/arch)
 *  - мини-игра “защита на техкоме” (3 вопроса)
 *  - автосохранение/Continue (localStorage)
 *  ====================== */

const story = {
  meta: {
    title: "CBONDS: Орбитальный Бэклог",
    subtitle: "космическая история о фидбэке, техкомах и задачах, которые хотят быть срочными",
    maxSteps: 18,
    whispers: [
      "Клиент сказал: “быстро, вчера и бесплатно”. Значит, по протоколу — паника.",
      "Приоритет определён. Он изменится ещё примерно 15 раз.",
      "Совет командования уже принял решение. Теперь оно должно принять тебя.",
      "Если задача описана “на вдохновении”, она обязательно вернётся… с комментариями.",
      "Немедленные задачи не приходят. Они врезаются.",
      "Dev — это тренировочный полигон. Prod — открытый космос.",
      "В демо всё выглядит прекрасно. На проде тоже… иногда."
    ],
    randomEvents: [
      { id:"client_urgent_ping", chance: 0.14, text:"Сигнал из сектора: «Клиент на линии. Нужно вчера и бесплатно».", delta:{ stress:+2, focus:-6 } },
      { id:"priority_shuffle", chance: 0.12, text:"В журнале навигации кто-то перетасовал приоритеты. Снова.", delta:{ stress:+1, scope:+1 } },
      { id:"immediate_incident", chance: 0.09, text:"Немедленная задача: микрометеорит пробил модуль. План спринта трещит.", delta:{ stress:+3, scope:+1, focus:-8 } },
      { id:"team_alignment", chance: 0.11, text:"Техлиды синхронизировались и предложили реалистичный план полёта.", delta:{ stress:-2, focus:+6, rep:+1 } },
    ],
  },

  initialState: {
    day: 1, budget: 100, stress: 0, scope: 1, focus: 100, rep: 0, steps: 0,
    role: "—", // "Продажи" | "Database" | "PO"
    quiz: { active:false, q:0, score:0, total:0, onFailNext:"", onPassNext:"" },
    flags: {
      onFeedbackCouncil:false, councilDecided:false, decision:"",
      backlogFormed:false,
      routedToDev:false, routedToDevDept:"",
      routedToDevelopment:false, developmentAccepted:false,
      onTechcom:false, techcomAccepted:false,
      techAnalysisDone:false, returnedForClarification:false,
      estimateSmall:false, estimateLarge:false,
      inSprint:false, sprintCut:false, sprintTweaked:false,
      demoDone:false, retroDone:false,
      immediateTaskHit:false,
      onDev:false, bugsFound:false, onProd:false, done:false,
      salesNotified:false,
      creepAwake:false
    }
  },

  nodes: {
    prologue: {
      chapter: 0,
      title: "Выбор роли",
      text:
`Добро пожаловать на орбитальную станцию CBONDS-1.

Откуда вы принимаете клиентский сигнал?
(Роль влияет на репутацию/стресс и на некоторые ответы.)`,
      choices: [
        { label:"Я из Продаж: клиент на линии, надо вчера", next:"start", delta:{ rep:+1, stress:+1 }, setRole:"Продажи" },
        { label:"Я из Database: запросы точные, но срочные", next:"start", delta:{ rep:+1, focus:-2 }, setRole:"Database" },
        { label:"Я PO: координирую фидбэк и держу процесс", next:"start", delta:{ rep:+2, stress:+1, focus:-2 }, setRole:"PO" },
      ]
    },

    start: {
      chapter: 1,
      title: "Сигнал с орбиты",
      text:
`Вы — координатор миссии по клиентскому запросу.
Сигнал почти всегда одинаковый: “быстро, вчера и бесплатно”.

Вопрос: как провести запрос через весь космический конвейер Cbonds — и вернуть результат клиенту?`,
      choices: [
        { label:"Принять фидбэк и уточнить проблему + критерии готовности", next:"intake", delta:{ focus:-3, rep:+1 } },
        { label:"Сразу обещать сроки клиенту (опасно)", next:"promise", delta:{ stress:+2, rep:-1, scope:+1 }, setFlags:{ creepAwake:true } },
        { label:"Собрать примеры/скриншоты/шаги воспроизведения (чтобы не вернулось)", next:"evidence", delta:{ day:+1, focus:-4, rep:+1 } },
        { label:"Сделать “космический one-pager”: что/зачем/эффект/риски", next:"onepager", delta:{ day:+1, focus:-4, rep:+2 } },
      ]
    },

    onepager: {
      chapter: 1,
      title: "One-pager",
      text:
`Вы упаковали запрос в одну страницу:
— что нужно
— зачем
— эффект
— риски/альтернативы
— критерии “сделано”

Теперь вы готовы к Совету командования.`,
      choices: [
        { label:"На Совет командования (совещание по фидбэку)", next:"feedback_council", delta:{ day:+1, focus:-3, rep:+2 }, setFlags:{ onFeedbackCouncil:true } },
        { label:"Сначала собрать предварительную оценку направления (front/back/data/…)", next:"pre_triage", delta:{ day:+1, focus:-5, rep:+1 } },
      ]
    },

    pre_triage: {
      chapter: 1,
      title: "Предварительный triage",
      text:
`Вы прикинули: это фронт/бэк/экстракция данных? Нужен ли дизайн? Архитектура?
Это повышает шансы быстро пройти техком и анализ.`,
      choices: [
        { label:"На Совет командования", next:"feedback_council", delta:{ day:+1, rep:+2, focus:-3 }, setFlags:{ onFeedbackCouncil:true } },
      ]
    },

    intake: {
      chapter: 1,
      title: "Приём запроса",
      text:
`Вы задаёте правильные вопросы: что болит, у кого, как воспроизвести, что будет “готово”.
Клиент отвечает вдохновенно. Много слов. Мало критериев.`,
      choices: [
        { label:"Подготовить питч для Совета (что/зачем/эффект/риски)", next:"feedback_council", delta:{ day:+1, focus:-4, rep:+1 }, setFlags:{ onFeedbackCouncil:true } },
        { label:"Попросить клиента дать конкретный пример/файл/тикер/ISIN (точность)", next:"evidence", delta:{ day:+1, focus:-3, rep:+1 }, req:{ roleAny:true } },
        { label:"Отложить “на потом”, чтобы не отвлекаться (клиент не поймёт)", next:"client_pressure", delta:{ stress:+2, rep:-1 } },
      ]
    },

    evidence: {
      chapter: 1,
      title: "Доказательства",
      text:
`У вас есть артефакты: примеры, шаги воспроизведения, бизнес-обоснование.
Это уменьшает шанс возврата “нужно конкретнее”.`,
      choices: [
        { label:"Вынести на Совет командования уверенно", next:"feedback_council", delta:{ day:+1, rep:+2, focus:-3 }, setFlags:{ onFeedbackCouncil:true } },
        { label:"Сделать ещё и предварительную оценку сложности", next:"pre_triage", delta:{ day:+1, focus:-4, rep:+1 } },
      ]
    },

    promise: {
      chapter: 1,
      title: "Опасное обещание",
      text:
`Вы говорите клиенту: “Сделаем быстро”.
Станция фиксирует обещание как объект, который охотится на план спринта.`,
      choices: [
        { label:"Срочно готовить питч на Совет командования", next:"feedback_council", delta:{ day:+1, stress:+1, focus:-6 }, setFlags:{ onFeedbackCouncil:true, creepAwake:true } },
        { label:"Попытаться протолкнуть напрямую в IT (мимо Совета)", next:"direct_to_it", delta:{ stress:+2, rep:-1, scope:+1 }, setFlags:{ creepAwake:true } },
      ]
    },

    client_pressure: {
      chapter: 1,
      title: "Давление клиента",
      text:
`Клиент напоминает каждые 3 часа.
Продажи пишут: “ну что там”.
Database добавляет: “у нас тоже спрашивают”.`,
      choices: [
        { label:"Всё равно выносить на Совет командования", next:"feedback_council", delta:{ day:+1, stress:+1, focus:-4 }, setFlags:{ onFeedbackCouncil:true } },
        { label:"Сделать временный workaround (снять давление)", next:"workaround", delta:{ day:+1, budget:-5, stress:+1, rep:+1 } },
      ]
    },

    workaround: {
      chapter: 1,
      title: "Временный обходной манёвр",
      text:
`Вы даёте временное решение.
Это снижает напряжение… и увеличивает риск вечности.`,
      choices: [
        { label:"Пока тихо — готовить задачу на Совет", next:"feedback_council", delta:{ day:+1, rep:+1, focus:-3 }, setFlags:{ onFeedbackCouncil:true } },
        { label:"Оставить как есть и надеяться, что забудут", next:"ending_eternal", delta:{}, ending:true },
      ]
    },

    feedback_council: {
      chapter: 2,
      title: "Совет командования (совещание по фидбэку)",
      text:
`В зале командования:
— генеральный директор Константин Васильев
— основатель Сергей Лялин
— коммерческий директор Сергей Зобов
— руководители и представители по повестке

Каждый запрос получает решение:
делаем / не делаем / делаем, но потом.`,
      choices: [
        { label:"Защитить запрос: цель → эффект → риски → критерии готовности", next:"council_decision", delta:{ stress:+1, focus:-4, rep:+2 }, setFlags:{ councilDecided:true } },
        { label:"Промолчать про критерии (потом вернётся на уточнение)", next:"council_decision", delta:{ stress:+2, focus:-6, rep:-1 }, setFlags:{ councilDecided:true, returnedForClarification:true } },
        { label:"Сыграть на “срочно и важно” (может сработать, но опасно)", next:"council_decision", delta:{ stress:+2, rep:+1, scope:+1 }, setFlags:{ councilDecided:true, creepAwake:true } },
        { label:"Если вы из Продаж: добавить кейс “клиент уйдёт” (жёстко)", next:"council_decision", delta:{ stress:+2, rep:+2, scope:+1 }, req:{ roleIs:"Продажи" }, setFlags:{ councilDecided:true, creepAwake:true } },
      ]
    },

    council_decision: {
      chapter: 2,
      title: "Решение Совета",
      text:
`Решение принято. На бумаге.
В реальности приоритет изменится ещё примерно 15 раз.

Дальше: у product owner формируется бэклог задач по приоритетам (до первого “срочно”).`,
      choices: [
        { label:"Решение: ДЕЛАЕМ (ставим в бэклог)", next:"backlog", delta:{ rep:+1 }, setFlags:{ decision:"do", backlogFormed:true } },
        { label:"Решение: ДЕЛАЕМ, НО ПОТОМ (дальний космос)", next:"later_orbit", delta:{ stress:+1, rep:-1 }, setFlags:{ decision:"later", backlogFormed:true } },
        { label:"Решение: НЕ ДЕЛАЕМ (попробовать переформулировать?)", next:"nope", delta:{ stress:+1, rep:-1 }, setFlags:{ decision:"no" } },
      ]
    },

    later_orbit: {
      chapter: 2,
      title: "Орбита “потом”",
      text:
`Задача отправлена на орбиту “потом”.
Там уже вращаются десятки таких же задач.`,
      choices: [
        { label:"Собрать новые аргументы/кейсы и вернуться на следующий Совет", next:"evidence", delta:{ day:+2, stress:+1, focus:-6, rep:+1 } },
        { label:"Принять судьбу и уйти дальше", next:"ending_eternal", delta:{}, ending:true },
      ]
    },

    nope: {
      chapter: 2,
      title: "Не делаем",
      text:
`Совет говорит: “не делаем”.
Иногда “не делаем” можно превратить в “делаем иначе” (меньше, проще, точнее).`,
      choices: [
        { label:"Переформулировать как меньший MVP", next:"backlog", delta:{ rep:+1, stress:+1, scope:-1 }, setFlags:{ decision:"do", backlogFormed:true } },
        { label:"Закрыть запрос клиенту (дипломатично)", next:"ending_neutral", delta:{}, ending:true },
      ]
    },

    backlog: {
      chapter: 3,
      title: "Бэклог product owner",
      text:
`У вас аккуратный бэклог по приоритетам.
Он будет красивым примерно до первого срочного запроса.

Куда маршрутизировать?
— сложная/концептуальная (“надо подумать”) → Отдел развития
— простая/фронтовая → на техком IT напрямую`,
      choices: [
        { label:"Маршрут: концептуальная → Отдел развития", next:"dev_development_techcom", delta:{ day:+1, stress:+1, focus:-4 }, setFlags:{ routedToDevelopment:true } },
        { label:"Маршрут: на техком IT (и там защита)", next:"techcom_gate_intro", delta:{ day:+1, stress:+1, focus:-4 }, setFlags:{ routedToDev:true } },
        { label:"Если вы из Database: продавить точность постановки сразу", next:"techcom_gate_intro", delta:{ day:+1, rep:+2, focus:-4 }, req:{ roleIs:"Database" }, setFlags:{ routedToDev:true } },
      ]
    },

    dev_development_techcom: {
      chapter: 3,
      title: "Техком отдела развития",
      text:
`На техкоме отдела развития основатель и генеральный директор решают: принимать / не принимать.
Если приняли — идёт проработка, потом задачи ставятся на IT (а вы ждёте).`,
      choices: [
        { label:"Принести чёткую формулировку и добиться принятия", next:"development_accept", delta:{ stress:+1, rep:+1 }, setFlags:{ onTechcom:true } },
        { label:"Принести “в общих чертах” (вероятен возврат)", next:"development_accept", delta:{ stress:+2, rep:-1, focus:-6 }, setFlags:{ onTechcom:true, returnedForClarification:true } },
      ]
    },

    development_accept: {
      chapter: 3,
      title: "Решение отдела развития",
      text:
`Если приняли — отлично, идёт проработка.
Если нет — возвращаемся за точностью.`,
      choices: [
        { label:"Принято! Ждать проработки → постановка на IT", next:"wait_dev_to_it", delta:{ day:+3, stress:+1, focus:-8, rep:+1 }, setFlags:{ developmentAccepted:true } },
        { label:"Не принято: вернуться и уточнить требования", next:"intake", delta:{ day:+2, stress:+1, focus:-6 }, setFlags:{ returnedForClarification:true } },
      ]
    },

    wait_dev_to_it: {
      chapter: 4,
      title: "Ожидание: развитие → IT",
      text:
`Проработка идёт. Отдел развития занят.
Ваша задача — дождаться постановки на IT.`,
      choices: [
        { label:"Настойчиво пинговать, но дипломатично", next:"techcom_gate_intro", delta:{ day:+2, stress:+1, focus:-6, rep:+1 }, setFlags:{ routedToDev:true } },
        { label:"Ждать молча (шанс провалиться в “потом”)", next:"later_orbit", delta:{ day:+3, stress:+1, focus:-8 }, setFlags:{ creepAwake:true } },
      ]
    },

    /** ===== MINI-GAME: techcom defense ===== */
    techcom_gate_intro: {
      chapter: 4,
      title: "Техком IT — Инженерный совет",
      text:
`На техкоме вам нужно пройти мини-защиту из 3 вопросов:
1) Что именно нужно?
2) Зачем это нужно?
3) Почему срочно именно сейчас?

Если ответите слабо — задача часто уезжает в отдел развития или возвращается на уточнение.`,
      choices: [
        { label:"Начать защиту на техкоме", next:"techcom_quiz_start", delta:{ stress:+1, focus:-3 }, setFlags:{ onTechcom:true } },
        { label:"Отложить и принести больше артефактов", next:"evidence", delta:{ day:+1, stress:+1, focus:-4, rep:+1 } },
      ]
    },

    techcom_quiz_start: {
      chapter: 4,
      title: "Защита на техкоме: вопрос 1/3",
      text:
`Вопрос 1: Что именно нужно сделать?`,
      quiz: {
        total: 3,
        questions: [
          {
            q: "Вопрос 1: Что именно нужно сделать?",
            options: [
              { label:"Чётко: изменить конкретный экран/API/выгрузку + критерии готовности", score:+1 },
              { label:"Общее: “сделайте чтобы было удобнее”", score:0 },
              { label:"Мистическое: “оно само понятно”", score:-1 },
            ]
          },
          {
            q: "Вопрос 2: Зачем это нужно?",
            options: [
              { label:"Бизнес-эффект: удержание/конверсия/снижение ручного труда + кто выигрывает", score:+1 },
              { label:"Потому что клиент просит", score:0 },
              { label:"Потому что срочно", score:-1 },
            ]
          },
          {
            q: "Вопрос 3: Почему срочно именно сейчас?",
            options: [
              { label:"Есть дедлайн/регуляторика/договорённость, и риск измерим", score:+1 },
              { label:"Ну… потому что вчера", score:0 },
              { label:"Срочно, иначе всё пропадёт (без фактов)", score:-1 },
            ]
          },
        ],
        onPassNext: "tech_analysis_entry",
        onFailNext: "techcom_fail"
      },
      choices: [
        { label:"Ответить: чётко и по делу", next:"techcom_quiz_answer", quizPick: { qIndex:0, optIndex:0 }, delta:{ rep:+1 } },
        { label:"Ответить: общими словами", next:"techcom_quiz_answer", quizPick: { qIndex:0, optIndex:1 }, delta:{ stress:+1 } },
        { label:"Ответить: на вдохновении (плохо)", next:"techcom_quiz_answer", quizPick: { qIndex:0, optIndex:2 }, delta:{ stress:+2 }, setFlags:{ creepAwake:true } },
      ]
    },

    techcom_quiz_q2: {
      chapter: 4,
      title: "Защита на техкоме: вопрос 2/3",
      text:`Вопрос 2: Зачем это нужно?`,
      choices: [
        { label:"Ответить: с бизнес-эффектом", next:"techcom_quiz_answer", quizPick: { qIndex:1, optIndex:0 }, delta:{ rep:+1 } },
        { label:"Ответить: “клиент просит”", next:"techcom_quiz_answer", quizPick: { qIndex:1, optIndex:1 }, delta:{ stress:+1 } },
        { label:"Ответить: “потому что срочно”", next:"techcom_quiz_answer", quizPick: { qIndex:1, optIndex:2 }, delta:{ stress:+2 }, setFlags:{ creepAwake:true } },
      ]
    },

    techcom_quiz_q3: {
      chapter: 4,
      title: "Защита на техкоме: вопрос 3/3",
      text:`Вопрос 3: Почему срочно именно сейчас?`,
      choices: [
        { label:"Ответить: с фактами (дедлайн/риск/стоимость)", next:"techcom_quiz_answer", quizPick: { qIndex:2, optIndex:0 }, delta:{ rep:+1 } },
        { label:"Ответить: “вчера”", next:"techcom_quiz_answer", quizPick: { qIndex:2, optIndex:1 }, delta:{ stress:+1 } },
        { label:"Ответить: “всё пропадёт” (без фактов)", next:"techcom_quiz_answer", quizPick: { qIndex:2, optIndex:2 }, delta:{ stress:+2 }, setFlags:{ creepAwake:true } },
      ]
    },

    techcom_quiz_answer: {
      chapter: 4,
      title: "Техком: фиксация ответа",
      text:
`(служебный узел)`,
      choices: [
        { label:"Продолжить", next:"techcom_quiz_next", delta:{} }
      ]
    },

    techcom_quiz_next: {
      chapter: 4,
      title: "Техком: следующий шаг",
      text:`(служебный узел)`,
      choices: [
        { label:"Дальше", next:"techcom_quiz_next", delta:{} }
      ]
    },

    techcom_fail: {
      chapter: 4,
      title: "Техком: защита не прошла",
      text:
`Инженерный совет не убедился.
Чаще всего это заканчивается так:
— “нужно конкретнее” (возврат на уточнение)
— или “давайте в отдел развития”`,
      choices: [
        { label:"Вернули на уточнение → собрать критерии и вернуться", next:"clarify_and_back", delta:{ day:+1, stress:+2, focus:-6, rep:-1 }, setFlags:{ returnedForClarification:true } },
        { label:"Уехало в отдел развития", next:"dev_development_techcom", delta:{ day:+1, stress:+2, focus:-4, rep:-1 }, setFlags:{ routedToDevelopment:true } },
      ]
    },

    tech_analysis_entry: {
      chapter: 5,
      title: "Техком пройден: в технический анализ",
      text:
`Задачу приняли на техкоме.
Теперь технический анализ: определить подразделение, уточнить детали, оценить.`,
      choices: [
        { label:"Перейти к техническому анализу", next:"tech_analysis", delta:{ day:+1, stress:+1, focus:-4 }, setFlags:{ techcomAccepted:true } }
      ]
    },

    /** ===== analysis / assignment / dept branches ===== */
    tech_analysis: {
      chapter: 5,
      title: "Технический анализ",
      text:
`Если задача описана размыто — она вернётся на уточнение.
Если описано хорошо — назначаем направление исполнения и идём к оценке.`,
      choices: [
        { label:"Описание точное → назначить направление", next:"assign_dept", delta:{ day:+1, stress:+1, focus:-3, rep:+1 }, setFlags:{ techAnalysisDone:true } },
        { label:"Описание размыто → вернули на уточнение", next:"clarify_and_back", delta:{ day:+1, stress:+2, focus:-8, rep:-1 }, setFlags:{ returnedForClarification:true } },
      ]
    },

    clarify_and_back: {
      chapter: 5,
      title: "Вернули на уточнение",
      text:
`Комментарий: “нужно конкретнее”.
Вы уточняете, добавляете критерии, примеры, ограничения.
После этого — снова техком и мини-защита.`,
      choices: [
        { label:"Вернуться на техком и защищать заново", next:"techcom_gate_intro", delta:{ day:+1, stress:+1, focus:-5, rep:+1 } },
        { label:"Отправить на орбиту “потом”", next:"ending_eternal", delta:{ rep:-1, stress:+1 }, setFlags:{ creepAwake:true }, ending:true },
      ]
    },

    assign_dept: {
      chapter: 5,
      title: "Назначение направления",
      text:
`Куда летит задача? Направление влияет на риски на dev/prod.`,
      choices: [
        { label:"Фронт (UI/страницы/формы)", next:"estimate", delta:{ stress:+1 }, setDept:"front" },
        { label:"Бэк (API/логика/интеграции)", next:"estimate", delta:{ stress:+1 }, setDept:"back" },
        { label:"Экстракция данных (выгрузки/потоки/ETL)", next:"estimate", delta:{ stress:+2 }, setDept:"data" },
        { label:"Дизайн (макеты/состояния/UX)", next:"estimate", delta:{ stress:+1, budget:-4 }, setDept:"design" },
        { label:"Архитектура (системные изменения)", next:"estimate", delta:{ stress:+2, focus:-4 }, setDept:"arch" },
      ]
    },

    estimate: {
      chapter: 5,
      title: "Оценка",
      text:
`Если оценка маленькая — шанс увидеть результат в этой жизни.
Если большая — задача станет частью истории станции.`,
      choices: [
        { label:"Оценка маленькая (есть шанс в этой жизни)", next:"sprint_planning", delta:{ day:+1, stress:+1, focus:-3 }, setFlags:{ estimateSmall:true } },
        { label:"Оценка большая (легенда станции)", next:"big_estimate", delta:{ day:+1, stress:+2, focus:-4 }, setFlags:{ estimateLarge:true, creepAwake:true } },
        { label:"Если репутация высокая: продавить дробление в MVP прямо сейчас", next:"sprint_planning", delta:{ day:+1, stress:+1, scope:-1, rep:+1 }, req:{ repMin:4 }, setFlags:{ estimateSmall:true } },
      ]
    },

    big_estimate: {
      chapter: 5,
      title: "Большая оценка",
      text:
`Большую задачу можно:
— дробить на этапы (MVP)
— ждать окна в спринте
— отправлять в “потом”`,
      choices: [
        { label:"Разбить на этапы (MVP → потом)", next:"sprint_planning", delta:{ scope:-1, rep:+1, stress:+1 }, setFlags:{ estimateSmall:true } },
        { label:"Ждать места в спринте как есть", next:"sprint_planning", delta:{ stress:+1, focus:-4 }, setFlags:{ creepAwake:true } },
        { label:"Орбита “потом”", next:"ending_eternal", delta:{ rep:-1 }, setFlags:{ creepAwake:true }, ending:true },
      ]
    },

    sprint_planning: {
      chapter: 6,
      title: "Сборка спринта — Полётный план",
      text:
`Раз в две недели: генеральный директор, руководитель развития, технический директор, техлиды, дизайнер, архитектор.
Начинается интеллигентная борьба за ресурсы.`,
      choices: [
        { label:"Защитить задачу и выбить место в спринте", next:"in_sprint", delta:{ stress:+2, focus:-6, rep:+2 }, setFlags:{ inSprint:true } },
        { label:"Не выбить место → ждать следующей сборки", next:"next_cycle", delta:{ day:+7, stress:+1, focus:-6, rep:-1 }, setFlags:{ creepAwake:true } },
        { label:"Компромисс: урезать объём ради попадания в спринт", next:"in_sprint", delta:{ scope:-1, stress:+1, rep:+1 }, setFlags:{ inSprint:true } },
      ]
    },

    next_cycle: {
      chapter: 6,
      title: "Следующий цикл",
      text:
`Спринт собран без вашей задачи.
Есть несколько дней на корректировки: можно написать генеральному директору и попросить поменять план.`,
      choices: [
        { label:"Попросить корректировку (дипломатия в вакууме)", next:"tweak_attempt", delta:{ day:+2, stress:+1, focus:-4 } },
        { label:"Ждать следующую сборку спринта", next:"sprint_planning", delta:{ day:+12, stress:+1, focus:-6 } },
      ]
    },

    tweak_attempt: {
      chapter: 6,
      title: "Корректировки после сборки",
      text:
`Иногда получается, иногда — нет. Это нормально.`,
      choices: [
        { label:"Удалось! Включили задачу", next:"in_sprint", delta:{ rep:+2, stress:+1 }, setFlags:{ inSprint:true, sprintTweaked:true } },
        { label:"Не удалось. Возвращаемся в очередь", next:"sprint_planning", delta:{ rep:-1, stress:+1, focus:-3 } },
      ]
    },

    in_sprint: {
      chapter: 7,
      title: "Задача в спринте",
      text:
`Задача в плане.
Но немедленные задачи могут появиться внезапно и вытеснить менее приоритетные.

В понедельник: демо + ретро.`,
      choices: [
        { label:"Начать спринт: демо + ретро", next:"demo_retro", delta:{ day:+1, stress:+1, focus:-4 }, setFlags:{ demoDone:true, retroDone:true } },
        { label:"Немедленная задача (авария) вытесняет план", next:"immediate_task", delta:{ stress:+3, focus:-8 }, setFlags:{ immediateTaskHit:true } },
        { label:"Задачу исключили из спринта (решение основателя)", next:"sprint_cut", delta:{ stress:+2, rep:-1 }, setFlags:{ sprintCut:true } },
      ]
    },

    sprint_cut: {
      chapter: 7,
      title: "Исключили из спринта",
      text:
`Вы можете злиться и понимать одновременно.
Задача снова в очереди.`,
      choices: [
        { label:"Вернуться к сборке следующего спринта", next:"sprint_planning", delta:{ day:+12, stress:+1, focus:-6 } },
        { label:"Переупаковать как “немедленную” (опасно)", next:"immediate_task", delta:{ stress:+2, rep:-1, scope:+1 }, setFlags:{ creepAwake:true } },
      ]
    },

    immediate_task: {
      chapter: 7,
      title: "Немедленная задача",
      text:
`Все ресурсы уходят на тушение пожара.
Плановые задачи отъезжают.`,
      choices: [
        { label:"Пережить аварию и вернуться к плановым", next:"sprint_planning", delta:{ day:+5, stress:+2, focus:-8 } },
        { label:"Использовать инцидент, чтобы усилить приоритет вашей задачи", next:"sprint_planning", delta:{ rep:+1, stress:+1 } },
      ]
    },

    demo_retro: {
      chapter: 8,
      title: "Демо и ретро",
      text:
`Что сделали, что не сделали, и почему опять не сделали “самое важное”.`,
      choices: [
        { label:"Отправить задачу в разработку", next:"dev_work", delta:{ day:+1, stress:+1, focus:-4 } },
        { label:"Ещё раз защитить приоритет (если риск вылета)", next:"in_sprint", delta:{ stress:+2, focus:-4, rep:+1 } },
      ]
    },

    dev_work: {
      chapter: 9,
      title: "Разработка",
      text:
`Разработчик делает магию и отдаёт на dev.
На dev почти всегда находятся баги/неточности/“я имел в виду другое”.`,
      choices: [
        { label:"Тестировать на dev строго по критериям", next:"dev_test", delta:{ day:+2, stress:+1, focus:-4, rep:+1 }, setFlags:{ onDev:true } },
        { label:"Срезать тесты ради скорости (опасно)", next:"prod_push", delta:{ day:+1, stress:+2, focus:-6, rep:-1 }, setFlags:{ onDev:true, creepAwake:true } },
        { label:"Если направление — data: заранее добавить контрольные выборки (умно)", next:"dev_test", delta:{ day:+1, stress:+1, rep:+2 }, req:{ deptIs:"data" }, setFlags:{ onDev:true } },
      ]
    },

    dev_test: {
      chapter: 10,
      title: "Тестирование на dev",
      text:
`Почти всегда что-то находится.
Запускается цикл доработок.`,
      choices: [
        { label:"Найти баги и вернуть в доработку", next:"rework_loop", delta:{ day:+1, stress:+2, focus:-5 }, setFlags:{ bugsFound:true } },
        { label:"Выглядит хорошо → на prod", next:"prod_push", delta:{ day:+1, stress:+1, focus:-3, rep:+1 } },
        { label:"Если направление — front: попросить дизайн-ревью перед prod", next:"prod_push", delta:{ day:+1, stress:+1, rep:+1 }, req:{ deptIs:"front" } },
      ]
    },

    rework_loop: {
      chapter: 10,
      title: "Цикл доработок",
      text:
`Доработка → dev → проверка… пока ответственный не будет доволен.`,
      choices: [
        { label:"Снова проверить на dev", next:"dev_test", delta:{ day:+1, stress:+1, focus:-3 } },
        { label:"Хватит. На prod (риск)", next:"prod_push", delta:{ day:+1, stress:+2, rep:-1 }, setFlags:{ creepAwake:true } },
      ]
    },

    prod_push: {
      chapter: 11,
      title: "Prod — открытый космос",
      text:
`Код на prod. Проверяем уже там.
Если не всё хорошо — назад в цикл.`,
      choices: [
        { label:"На prod всё хорошо → закрыть задачу", next:"done", delta:{ day:+1, stress:-2, rep:+2, focus:+6 }, setFlags:{ onProd:true, done:true } },
        { label:"На prod не всё хорошо → обратно", next:"rework_loop", delta:{ day:+1, stress:+2, focus:-6 }, setFlags:{ onProd:true, bugsFound:true } },
        { label:"Если направление — arch: включить дополнительную проверку (спасает)", next:"done", delta:{ day:+1, stress:-1, rep:+3 }, req:{ deptIs:"arch" }, setFlags:{ onProd:true, done:true } },
      ]
    },

    done: {
      chapter: 12,
      title: "Задача закрыта",
      text:
`Ответственный обновляет клиентские запросы.
Продажи сообщают клиенту: “мы это сделали”.`,
      choices: [
        { label:"Сообщить продажам и закрыть запрос", next:"ending_win", delta:{ rep:+1 }, setFlags:{ salesNotified:true }, ending:true },
        { label:"Сделать постмортем и улучшить процесс", next:"ending_best", delta:{ rep:+2, focus:+4 }, ending:true },
        { label:"Открыть следующий запрос (проверить судьбу)", next:"start", delta:{ day:+1, stress:+1, scope:+1 }, setFlags:{ creepAwake:true } },
      ]
    },

    ending_win: {
      chapter: 13,
      title: "Финал: Полёт завершён",
      text:
`Вы провели запрос через Совет → техком → анализ → спринт → dev → prod.
Клиент уведомлён. Станция выжила.

Где-то уже набирается сообщение: “а можно ещё, быстро и бесплатно?”`,
      ending:true
    },

    ending_best: {
      chapter: 13,
      title: "Финал: Орбитальная стабильность",
      text:
`Задача сделана, клиент доволен, процесс стал чуть лучше.
В космосе это редкость: победа не только над задачей, но и над хаосом.`,
      ending:true
    },

    ending_neutral: {
      chapter: 13,
      title: "Финал: Нейтральная орбита",
      text:
`Вы отказали корректно и сохранили отношения.
Иногда это самый правильный релиз.`,
      ending:true
    },

    direct_to_it: {
      chapter: 2,
      title: "Прямо в IT, минуя космическую бюрократию",
      text:
`Иногда это работает для совсем простых задач.
Но если задача “надо подумать” — она возвращается бумерангом.`,
      choices: [
        { label:"Повезло: простое → всё равно на техком (с защитой)", next:"techcom_gate_intro", delta:{ day:+1, stress:+1, rep:+1 }, setFlags:{ routedToDev:true } },
        { label:"Не повезло: “надо подумать” → уехало в развитие", next:"dev_development_techcom", delta:{ day:+1, stress:+2, rep:-1 }, setFlags:{ routedToDevelopment:true, creepAwake:true } },
      ]
    },
  }
};

/** =========================================
 *  ENGINE
 *  ========================================= */
const $ = (id)=>document.getElementById(id);

const el = {
  overlay: $("overlay"),
  btnNew: $("btnNew"),
  btnContinue: $("btnContinue"),
  btnResetSave: $("btnResetSave"),
  audioToggle2: $("audioToggle2"),
  typeToggle2: $("typeToggle2"),

  glitch: $("glitch"),
  title: $("gameTitle"),
  sub: $("gameSub"),

  nodeTitle: $("nodeTitle"),
  nodeText: $("nodeText"),
  nodeMeta: $("nodeMeta"),
  nodeBadge: $("nodeBadge"),
  whisper: $("whisper"),
  choices: $("choices"),

  restart: $("restartBtn"),
  continueBtn: $("continueBtn"),
  back: $("backBtn"),
  skip: $("skipBtn"),

  stRole: $("stRole"),
  stDay: $("stDay"),
  stBudget: $("stBudget"),
  stStress: $("stStress"),
  stScope: $("stScope"),
  stFocus: $("stFocus"),

  creepBar: $("creepBar"),
  creepLabel: $("creepLabel"),
  creepHint: $("creepHint"),
  riskVal: $("riskVal"),
  repVal: $("repVal"),

  dots: $("dots"),
  stepsNow: $("stepsNow"),
  stepsMax: $("stepsMax"),
  log: $("log"),

  audioToggle: $("audioToggle"),
  typeToggle: $("typeToggle"),

  pillRole: $("pillRole"),
  pillDay: $("pillDay"),
  pillBudget: $("pillBudget"),
  pillStress: $("pillStress"),
  pillScope: $("pillScope"),

  deptHint: $("deptHint"),
};

const SAVE_KEY = "cbonds_orbit_backlog_save_v1";

let state = structuredClone(story.initialState);
let currentId = "prologue";
let history = [];
let typing = { running:false, fullText:"", idx:0, timer:null };

const Audio = (() => {
  let ctx = null;
  function ensure(){
    if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
    return ctx;
  }
  function beep(freq=220, ms=40, type="sine", gain=0.025){
    if (!el.audioToggle.checked) return;
    const c = ensure();
    const o = c.createOscillator();
    const g = c.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(c.destination);
    o.start();
    o.stop(c.currentTime + ms/1000);
  }
  function click(){ beep(320, 28, "triangle", 0.02); }
  function bad(){ beep(120, 60, "sawtooth", 0.03); setTimeout(()=>beep(90, 70, "sawtooth", 0.025), 80); }
  function good(){ beep(520, 35, "sine", 0.02); setTimeout(()=>beep(680, 35, "sine", 0.018), 60); }
  return { click, bad, good };
})();

function clamp(n, a=-9999, b=9999){ return Math.max(a, Math.min(b, n)); }
function num(v){ return (typeof v==="number" && !Number.isNaN(v)) ? v : 0; }
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function applyDelta(delta){
  if (!delta) return;
  for (const [k, dv] of Object.entries(delta)){
    state[k] = clamp(num(state[k]) + num(dv));
  }
  state.focus = clamp(state.focus, 0, 120);
  state.stress = clamp(state.stress, 0, 30);
  state.scope = clamp(state.scope, 0, 30);
  state.budget = clamp(state.budget, -50, 999);
  state.rep = clamp(state.rep, -10, 10);
}

function setFlags(obj){
  if (!obj) return;
  for (const [k,v] of Object.entries(obj)){
    state.flags[k] = !!v;
  }
}
function setRole(role){
  state.role = role || "—";
}
function setDept(dept){
  state.flags.routedToDevDept = dept || "";
}

function creepScore(){
  const s = state.stress*3 + state.scope*2 + Math.max(0, 70 - state.focus)*0.6;
  // dept amplifiers (data/arch more fragile)
  const dept = state.flags.routedToDevDept;
  const amp = dept === "data" ? 6 : dept === "arch" ? 5 : dept === "back" ? 3 : dept === "front" ? 2 : 0;
  return clamp(Math.round(s + amp), 0, 100);
}

function labelRisk(){
  const c = creepScore();
  if (c < 28) return ["низкий", "ok"];
  if (c < 55) return ["средний", "warn"];
  return ["высокий", "bad"];
}
function labelRep(){
  if (state.rep >= 6) return "сильная";
  if (state.rep >= 2) return "ровная+";
  if (state.rep >= -1) return "ровная";
  if (state.rep >= -5) return "напряжённая";
  return "хрупкая";
}
function deptHuman(){
  const d = state.flags.routedToDevDept;
  if (d==="front") return "Фронт: риск “визуально ок, логика спорит”";
  if (d==="back") return "Бэк: риск “интеграции и крайние случаи”";
  if (d==="data") return "Экстракция данных: риск “точность/проверки/выборки”";
  if (d==="design") return "Дизайн: риск “состояния/edge-cases/согласования”";
  if (d==="arch") return "Архитектура: риск “скрытые зависимости”";
  return "Подразделение ещё не назначено.";
}

function setGlitch(on){
  if (!on) return;
  el.glitch.classList.remove("on");
  void el.glitch.offsetWidth;
  el.glitch.classList.add("on");
}

function stopTyping(){
  if (typing.timer) clearInterval(typing.timer);
  typing.running = false;
  typing.timer = null;
}

function typeText(full){
  stopTyping();
  typing.fullText = full;
  typing.idx = 0;
  el.nodeText.textContent = "";

  if (!el.typeToggle.checked){
    el.nodeText.textContent = full;
    return;
  }
  typing.running = true;
  typing.timer = setInterval(() => {
    typing.idx += 2;
    el.nodeText.textContent = typing.fullText.slice(0, typing.idx);
    if (typing.idx >= typing.fullText.length){
      stopTyping();
    }
  }, 12);
}

function meetsReq(req){
  if (!req) return true;
  if (req.dayMin != null && state.day < req.dayMin) return false;
  if (req.budgetMin != null && state.budget < req.budgetMin) return false;
  if (req.stressMax != null && state.stress > req.stressMax) return false;
  if (req.focusMin != null && state.focus < req.focusMin) return false;
  if (req.scopeMax != null && state.scope > req.scopeMax) return false;
  if (req.repMin != null && state.rep < req.repMin) return false;
  if (req.roleIs && state.role !== req.roleIs) return false;
  if (req.deptIs && state.flags.routedToDevDept !== req.deptIs) return false;
  return true;
}

function maybeWhisper(){
  const node = story.nodes[currentId];
  if (node?.ending) { el.whisper.hidden = true; return; }
  const list = story.meta.whispers || [];
  if (!list.length) { el.whisper.hidden = true; return; }

  const c = creepScore();
  const prob = c < 28 ? 0.35 : c < 55 ? 0.55 : 0.75;
  if (Math.random() > prob){ el.whisper.hidden = true; return; }
  const line = list[Math.floor(Math.random() * list.length)];
  el.whisper.textContent = line;
  el.whisper.hidden = false;
}

function maybeRandomEvent(){
  const node = story.nodes[currentId];
  if (node?.ending) return null;

  const events = story.meta.randomEvents || [];
  for (const e of events){
    const c = creepScore();
    const bonus = c >= 55 ? 0.06 : c >= 28 ? 0.03 : 0;
    // dept adds tiny chaos
    const dept = state.flags.routedToDevDept;
    const deptBonus = (dept==="data" || dept==="arch") ? 0.02 : 0;
    const p = (e.chance || 0) + bonus + deptBonus;
    if (Math.random() < p){
      applyDelta(e.delta);
      if (c >= 55) setGlitch(true);
      return e;
    }
  }
  return null;
}

function renderProgress(){
  el.stepsMax.textContent = story.meta.maxSteps;
  el.stepsNow.textContent = state.steps;
  el.dots.innerHTML = "";
  for (let i=1;i<=story.meta.maxSteps;i++){
    const d = document.createElement("div");
    d.className = "p";
    if (i <= state.steps) d.classList.add("on");
    if (creepScore() >= 55 && i === state.steps) d.classList.add("bad");
    el.dots.appendChild(d);
  }
}

function updateTopPills(){
  el.stRole.textContent = state.role;
  el.stDay.textContent = state.day;
  el.stBudget.textContent = state.budget;
  el.stStress.textContent = state.stress;
  el.stScope.textContent = state.scope;
  el.stFocus.textContent = state.focus;

  const pillDots = [
    [el.pillRole, state.role === "—" ? "warn" : "ok"],
    [el.pillDay, "ok"],
    [el.pillBudget, state.budget >= 40 ? "ok" : state.budget >= 15 ? "warn" : "bad"],
    [el.pillStress, state.stress <= 6 ? "ok" : state.stress <= 12 ? "warn" : "bad"],
    [el.pillScope, state.scope <= 3 ? "ok" : state.scope <= 6 ? "warn" : "bad"],
  ];
  for (const [pill, lvl] of pillDots){
    const d = pill.querySelector(".dot");
    d.className = "dot " + (lvl==="ok" ? "ok" : lvl==="warn" ? "warn" : "bad");
  }

  const c = creepScore();
  el.creepBar.style.width = c + "%";
  if (c < 28){ el.creepLabel.textContent = "спокоен"; el.creepHint.textContent = "Пока границы держатся."; }
  else if (c < 55){ el.creepLabel.textContent = "шевелится"; el.creepHint.textContent = "Скоуп ищет лазейки."; }
  else { el.creepLabel.textContent = "проснулся"; el.creepHint.textContent = "Немедленные задачи и возвраты учащаются."; }

  el.riskVal.textContent = labelRisk()[0];
  el.repVal.textContent = labelRep();
  el.deptHint.textContent = deptHuman();
}

/** -------- Save / Load -------- */
function saveGame(){
  const payload = {
    v: 1,
    state,
    currentId,
    history,
    logHtml: el.log.innerHTML,
    settings: {
      audio: el.audioToggle.checked,
      type: el.typeToggle.checked
    }
  };
  localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
}
function hasSave(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return false;
    const obj = JSON.parse(raw);
    return !!obj && obj.v === 1;
  } catch { return false; }
}
function loadGame(){
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return false;
  try{
    const obj = JSON.parse(raw);
    if (!obj || obj.v !== 1) return false;
    state = obj.state;
    currentId = obj.currentId;
    history = obj.history || [];
    el.log.innerHTML = obj.logHtml || "";
    if (obj.settings){
      el.audioToggle.checked = !!obj.settings.audio;
      el.typeToggle.checked = !!obj.settings.type;
      el.audioToggle2.checked = !!obj.settings.audio;
      el.typeToggle2.checked = !!obj.settings.type;
    }
    return true;
  } catch {
    return false;
  }
}
function resetSave(){
  localStorage.removeItem(SAVE_KEY);
}

/** -------- Log -------- */
function pushLog(choiceLabel){
  const node = story.nodes[currentId];
  const div = document.createElement("div");
  div.className = "log-item";
  div.innerHTML = `<div><b>${escapeHtml(node?.title ?? currentId)}</b></div><div class="t">→ ${escapeHtml(choiceLabel)}</div>`;
  el.log.prepend(div);
}

/** -------- Quiz engine -------- */
function quizInit(node){
  state.quiz.active = true;
  state.quiz.q = 0;
  state.quiz.score = 0;
  state.quiz.total = node.quiz.total || (node.quiz.questions?.length || 0);
  state.quiz.onPassNext = node.quiz.onPassNext || "";
  state.quiz.onFailNext = node.quiz.onFailNext || "";
}
function quizPick(qIndex, optIndex, node){
  const q = node.quiz.questions[qIndex];
  const opt = q.options[optIndex];
  state.quiz.score += num(opt.score);
  state.quiz.q = qIndex + 1;
}
function quizNextNode(){
  if (!state.quiz.active) return null;
  if (state.quiz.q >= state.quiz.total){
    // pass threshold: score >= 2 (out of 3)
    const passed = state.quiz.score >= 2;
    const next = passed ? state.quiz.onPassNext : state.quiz.onFailNext;
    state.quiz.active = false;
    return next;
  }
  // map q index to node id
  if (state.quiz.q === 1) return "techcom_quiz_q2";
  if (state.quiz.q === 2) return "techcom_quiz_q3";
  return null;
}

/** -------- Render -------- */
function renderNode(){
  const node = story.nodes[currentId];
  if (!node){
    el.nodeTitle.textContent = "Ошибка";
    el.nodeMeta.textContent = "";
    el.nodeBadge.textContent = "";
    typeText(`Не найден узел: ${currentId}`);
    el.choices.innerHTML = "";
    el.whisper.hidden = true;
    return;
  }

  el.title.textContent = story.meta.title || "Игра";
  el.sub.textContent = story.meta.subtitle || "";
  el.nodeTitle.textContent = node.title || "";
  el.nodeBadge.textContent = node.chapter != null ? ("Глава " + node.chapter) : "—";

  const flagsOn = Object.entries(state.flags).filter(([k,v])=>v).map(([k])=>k).slice(0,6).join(", ") || "—";
  const dept = state.flags.routedToDevDept || "—";
  el.nodeMeta.textContent = `id: ${currentId} · роль: ${state.role} · dept: ${dept} · флаги: ${flagsOn}`;

  // quiz special init (first quiz node)
  if (node.quiz && !state.quiz.active){
    quizInit(node);
  }

  // render text
  typeText(node.text || "");

  // choices
  el.choices.innerHTML = "";
  if (node.ending){
    const b = document.createElement("button");
    b.className = "choice";
    b.innerHTML = `Сыграть ещё раз<div class="choice-meta"><span class="tag ok">restart</span></div>`;
    b.addEventListener("click", newMission);
    el.choices.appendChild(b);
  } else {
    const visibleChoices = (node.choices || []).filter(ch => meetsReq(ch.req));
    for (const ch of visibleChoices){
      const b = document.createElement("button");
      b.className = "choice";

      const tags = [];
      if (ch.delta){
        if (ch.delta.stress > 0) tags.push(`<span class="tag bad">+стресс</span>`);
        if (ch.delta.stress < 0) tags.push(`<span class="tag ok">-стресс</span>`);
        if (ch.delta.scope > 0) tags.push(`<span class="tag warn">+скоуп</span>`);
        if (ch.delta.budget < 0) tags.push(`<span class="tag warn">-бюджет</span>`);
        if (ch.delta.rep > 0) tags.push(`<span class="tag ok">+репутация</span>`);
        if (ch.delta.focus < 0) tags.push(`<span class="tag warn">-фокус</span>`);
      }
      if (ch.req?.repMin != null || ch.req?.focusMin != null || ch.req?.roleIs || ch.req?.deptIs) tags.push(`<span class="tag">условие</span>`);
      if (ch.setDept) tags.push(`<span class="tag">dept</span>`);
      if (ch.quizPick) tags.push(`<span class="tag">ответ</span>`);

      b.innerHTML = `${escapeHtml(ch.label)}<div class="choice-meta">${tags.join(" ")}</div>`;
      b.addEventListener("click", () => choose(ch));
      el.choices.appendChild(b);
    }
  }

  updateTopPills();
  renderProgress();
  maybeWhisper();

  el.back.disabled = history.length === 0;
  saveGame();
}

function choose(choice){
  history.push({ prevId: currentId, prevState: structuredClone(state), prevLog: el.log.innerHTML });

  Audio.click();
  state.steps = clamp(state.steps + 1, 0, story.meta.maxSteps);

  // apply
  applyDelta(choice.delta);
  setFlags(choice.setFlags);
  if (choice.setRole) setRole(choice.setRole);
  if (choice.setDept) setDept(choice.setDept);

  // quiz pick handling
  const node = story.nodes[currentId];
  if (choice.quizPick && node?.quiz){
    quizPick(choice.quizPick.qIndex, choice.quizPick.optIndex, node);
  }

  // move
  let nextId = choice.next;

  // special: service quiz nodes
  if (nextId === "techcom_quiz_answer"){
    // after answer: move to next question or finish
    const nextQuiz = quizNextNode();
    if (nextQuiz){
      // show brief feedback in whisper
      el.whisper.textContent = `Техком фиксирует ответ. Счёт: ${state.quiz.score}/${state.quiz.total}`;
      el.whisper.hidden = false;
      nextId = nextQuiz;
    } else {
      // should not happen, but fallback
      nextId = "techcom_fail";
    }
  }
  if (nextId === "techcom_quiz_next"){
    // unused fallback
    nextId = quizNextNode() || "techcom_fail";
  }

  // random event after move (only if not ending)
  currentId = nextId;
  const ev = maybeRandomEvent();
  if (ev){
    el.whisper.textContent = "Событие: " + ev.text;
    el.whisper.hidden = false;
    if (creepScore() >= 55) { setGlitch(true); Audio.bad(); }
    else Audio.good();
  }

  if (creepScore() >= 60) setGlitch(true);
  pushLog(choice.label);

  renderNode();
}

function newMission(){
  stopTyping();
  state = structuredClone(story.initialState);
  currentId = "prologue";
  history = [];
  el.log.innerHTML = "";
  renderNode();
}
function continueMission(){
  stopTyping();
  if (!loadGame()){
    // no save, start new
    newMission();
    return;
  }
  renderNode();
}
function back(){
  stopTyping();
  if (!history.length) return;
  const last = history.pop();
  currentId = last.prevId;
  state = last.prevState;
  el.log.innerHTML = last.prevLog || el.log.innerHTML;
  Audio.click();
  renderNode();
}

/** UI actions */
el.restart.addEventListener("click", () => { el.overlay.style.display = "flex"; });
el.continueBtn.addEventListener("click", () => { el.overlay.style.display = "flex"; });
el.back.addEventListener("click", back);
el.skip.addEventListener("click", () => {
  if (!typing.running) return;
  stopTyping();
  el.nodeText.textContent = typing.fullText;
});

// sync toggles between overlay and panel
function syncToggles(fromOverlay=false){
  if (fromOverlay){
    el.audioToggle.checked = el.audioToggle2.checked;
    el.typeToggle.checked = el.typeToggle2.checked;
  } else {
    el.audioToggle2.checked = el.audioToggle.checked;
    el.typeToggle2.checked = el.typeToggle.checked;
  }
  saveGame();
}
el.audioToggle.addEventListener("change", ()=>syncToggles(false));
el.typeToggle.addEventListener("change", ()=>syncToggles(false));
el.audioToggle2.addEventListener("change", ()=>syncToggles(true));
el.typeToggle2.addEventListener("change", ()=>syncToggles(true));

el.btnNew.addEventListener("click", () => {
  syncToggles(true);
  el.overlay.style.display = "none";
  newMission();
});
el.btnContinue.addEventListener("click", () => {
  syncToggles(true);
  el.overlay.style.display = "none";
  continueMission();
});
el.btnResetSave.addEventListener("click", () => {
  resetSave();
  el.btnContinue.textContent = "Продолжить (нет сохранения)";
  Audio.bad();
});

// warm up audio context
document.addEventListener("click", () => { if (el.audioToggle.checked) Audio.click(); }, { once:true });

/** boot */
(function boot(){
  // enable/disable continue button based on save
  const ok = hasSave();
  el.btnContinue.disabled = !ok;
  el.btnContinue.textContent = ok ? "Продолжить миссию" : "Продолжить (нет сохранения)";
  // also keep panel continue button meaningful
  el.continueBtn.disabled = !ok;

  // start with overlay; don't render main until user picks
  // but show a snapshot if save exists (optional)
  // We'll render a blank prologue so UI isn't empty if overlay closed somehow
  currentId = "prologue";
  renderNode();
})();
</script>
</body>
</html>
