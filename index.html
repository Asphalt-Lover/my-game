<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CBONDS: Орбитальный Бэклог — v2</title>
  <style>
    :root{
      --bg0:#07070a; --bg1:#0b0d12; --ink:#e9eef7; --muted:rgba(233,238,247,.68);
      --glass: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --danger: rgba(255,120,120,.95);
      --ok: rgba(120,255,190,.95);
      --warn: rgba(255,205,120,.95);
      --radius: 18px;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% 10%, #14183b 0%, transparent 55%),
                  radial-gradient(900px 700px at 70% 30%, #2a1440 0%, transparent 60%),
                  radial-gradient(800px 600px at 30% 80%, #0c3b2a 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--ink);
      overflow-x:hidden;
    }
    .bg-drift{
      position:fixed; inset:-30%;
      background:
        radial-gradient(900px 600px at 20% 35%, rgba(138,115,255,.20), transparent 58%),
        radial-gradient(850px 700px at 75% 30%, rgba(255,120,200,.12), transparent 60%),
        radial-gradient(800px 620px at 45% 80%, rgba(110,255,210,.10), transparent 55%);
      filter: blur(18px) saturate(1.12);
      animation: drift 18s ease-in-out infinite alternate;
      opacity:.9;
      pointer-events:none;
    }
    @keyframes drift{
      0%{ transform: translate3d(-2%, -1%, 0) scale(1.02) rotate(-.5deg); }
      100%{ transform: translate3d(2%, 1.5%, 0) scale(1.06) rotate(.6deg); }
    }
    .grain{
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.18;
      pointer-events:none;
    }
    .wrap{ max-width: 1100px; margin: 0 auto; padding: 22px 16px 44px; position:relative; }
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      position:sticky; top:0; z-index:4;
      padding: 12px 10px;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(8,9,14,.78), rgba(8,9,14,.38));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: 0 10px 40px rgba(0,0,0,.28);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width: 240px; }
    .logo{
      width:34px; height:34px; border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.28), rgba(255,255,255,.06)),
                  linear-gradient(135deg, rgba(170,120,255,.55), rgba(120,255,210,.25));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
      position:relative; overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-30%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent);
      transform: rotate(25deg);
      animation: shine 3.6s ease-in-out infinite;
      opacity:.7;
    }
    @keyframes shine{
      0%{ transform: translateX(-35%) rotate(25deg); opacity:.0; }
      25%{ opacity:.7; }
      55%{ opacity:.6; }
      100%{ transform: translateX(35%) rotate(25deg); opacity:.0; }
    }
    h1{ margin:0; font-size: 14px; letter-spacing:.2px; font-weight:800; }
    .subtitle{ font-size: 12px; color: var(--muted); margin-top:2px; }
    .top-right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(233,238,247,.86);
      display:flex; gap:8px; align-items:center;
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.25); }
    .dot.ok{ background: rgba(120,255,190,.85); }
    .dot.warn{ background: rgba(255,205,120,.85); }
    .dot.bad{ background: rgba(255,120,120,.85); }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card-inner{ padding: 16px 16px 14px; }

    .scene-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom: 8px;
    }
    .scene-title{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .badge{
      font-size: 11px;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: rgba(233,238,247,.8);
      white-space:nowrap;
    }
    .scene-text{
      margin: 0;
      line-height: 1.62;
      color: rgba(233,238,247,.93);
      white-space: pre-wrap;
      min-height: 120px;
    }
    .whisper{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      color: rgba(233,238,247,.70);
      font-style: italic;
      font-size: 13px;
    }
    .choices{ display:grid; gap:10px; margin-top: 14px; }
    button.choice{
      cursor:pointer;
      text-align:left;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color: rgba(233,238,247,.96);
      padding: 12px 12px;
      font-size: 14px;
      transition: transform .05s ease, border-color .12s ease, background .12s ease, filter .12s ease;
      position:relative;
      overflow:hidden;
    }
    button.choice:hover{
      border-color: rgba(255,255,255,.26);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
      filter: brightness(1.03);
    }
    button.choice:active{ transform: translateY(1px); }
    .choice-meta{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(233,238,247,.62);
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tag{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
      padding: 2px 8px;
      border-radius: 999px;
    }
    .tag.bad{ border-color: rgba(255,120,120,.30); color: rgba(255,160,160,.92); }
    .tag.warn{ border-color: rgba(255,205,120,.30); color: rgba(255,205,120,.92); }
    .tag.ok{ border-color: rgba(120,255,190,.30); color: rgba(140,255,210,.92); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
    .ghost{
      cursor:pointer;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: transparent;
      color: rgba(233,238,247,.86);
      padding: 10px 12px;
      font-size: 13px;
    }
    .ghost:hover{ border-color: rgba(255,255,255,.30); background: rgba(255,255,255,.03); }
    .ghost:disabled{ opacity:.45; cursor:not-allowed; }

    .panel-title{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin:0 0 10px;
    }
    .panel-title h2{ margin:0; font-size: 13px; font-weight: 900; letter-spacing:.25px; color: rgba(233,238,247,.86); }
    .tiny{ font-size: 12px; color: rgba(233,238,247,.62); }

    .meter{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      border-radius: 16px;
      padding: 10px 10px;
      margin-bottom: 12px;
    }
    .meter-top{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .bar{
      height: 10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      margin-top: 10px;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(120,255,190,.85), rgba(255,205,120,.85), rgba(255,120,120,.85));
      transition: width .35s ease;
    }

    .kv{
      display:grid; grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .k{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px 10px;
      min-height: 52px;
    }
    .k .lbl{ font-size: 11px; color: rgba(233,238,247,.62); }
    .k .val{ font-size: 14px; font-weight: 900; margin-top: 2px; }

    details{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px 10px;
      margin-top: 12px;
    }
    summary{
      cursor:pointer;
      font-weight: 800;
      font-size: 12px;
      color: rgba(233,238,247,.86);
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .log{
      margin-top:10px;
      display:grid; gap:8px;
      max-height: 240px;
      overflow:auto;
      padding-right:6px;
    }
    .log-item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      border-radius: 14px;
      padding: 10px 10px;
      font-size: 12px;
      color: rgba(233,238,247,.82);
    }
    .log-item .t{ color: rgba(233,238,247,.62); font-size: 11px; margin-top: 4px; }

    .map{
      margin-top: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px 10px;
    }
    .dots{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
    .p{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .p.on{ background: rgba(120,255,190,.35); border-color: rgba(120,255,190,.45); }
    .p.bad{ background: rgba(255,120,120,.25); border-color: rgba(255,120,120,.45); }

    .art{
      height: 120px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(700px 220px at 30% 30%, rgba(255,255,255,.10), transparent 65%),
        linear-gradient(135deg, rgba(170,120,255,.22), rgba(120,255,210,.10));
      position:relative;
      overflow:hidden;
    }
    .art svg{ position:absolute; inset:0; width:100%; height:100%; opacity:.85; }
    .art .glow{
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 35%, rgba(255,255,255,.12), transparent 55%);
      filter: blur(20px);
      animation: drift2 14s ease-in-out infinite alternate;
    }
    @keyframes drift2{ from{ transform: translate(-1%, 1%) scale(1.02); } to{ transform: translate(2%, -1%) scale(1.06); } }

    .glitch{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:0;
      background:
        linear-gradient(90deg, rgba(255,60,160,.12), transparent 24%, rgba(80,255,210,.10) 55%, transparent 75%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.06) 0 1px, transparent 1px 3px);
      mix-blend-mode: screen;
      transform: translateZ(0);
    }
    .glitch.on{ animation: glitch 420ms linear 1; }
    @keyframes glitch{
      0%{ opacity:0; transform: translate(0,0); }
      15%{ opacity:.55; transform: translate(8px,-6px) skewX(2deg); }
      35%{ opacity:.35; transform: translate(-10px,4px) skewX(-2deg); }
      55%{ opacity:.45; transform: translate(6px,8px) skewY(1deg); }
      100%{ opacity:0; transform: translate(0,0); }
    }

    .overlay{
      position:fixed; inset:0; z-index:10;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.52);
      backdrop-filter: blur(10px);
      padding: 18px;
    }
    .overlay .modal{
      width:min(860px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(14,14,20,.78);
      box-shadow: 0 30px 120px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .overlay .modal .top{
      padding: 16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .overlay .modal .top .t1{ font-weight: 950; letter-spacing:.2px; }
    .overlay .modal .top .t2{ color: rgba(233,238,247,.65); font-size: 12px; margin-top:4px; }
    .overlay .modal .body{ padding: 14px 16px 16px; }
    .overlay .grid2{ display:grid; grid-template-columns: 1.1fr .9fr; gap:12px; }
    @media (max-width: 860px){ .overlay .grid2{ grid-template-columns: 1fr; } }
    .overlay .box{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding: 12px 12px;
    }
    .overlay .box h3{ margin:0 0 8px; font-size: 13px; font-weight: 950; color: rgba(233,238,247,.88); }
    .overlay .box p{ margin:0; font-size: 12px; line-height:1.6; color: rgba(233,238,247,.72); }
    .overlay .actions{ display:grid; gap:10px; margin-top: 12px; }
    .overlay .small{ margin-top:10px; font-size:12px; color: rgba(233,238,247,.62); }
    code{ color: rgba(233,238,247,.85); }
  </style>
</head>
<body>
  <div class="bg-drift"></div>
  <div class="grain"></div>
  <div class="glitch" id="glitch"></div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="top">
        <div>
          <div class="t1">CBONDS: Орбитальный Бэклог — v2</div>
          <div class="t2">Живой симулятор: люди → решения → спринты → dev/prod. Космос прилагается.</div>
        </div>
        <div class="tiny">
          <label style="display:inline-flex; gap:8px; align-items:center; cursor:pointer;">
            <input type="checkbox" id="audioToggle2" checked />
            звук
          </label>
          &nbsp;·&nbsp;
          <label style="display:inline-flex; gap:8px; align-items:center; cursor:pointer;">
            <input type="checkbox" id="typeToggle2" checked />
            печать
          </label>
        </div>
      </div>
      <div class="body">
        <div class="grid2">
          <div class="box">
            <h3>Как играть</h3>
            <p>
              Вы выбираете реплики и решения — как в реальных обсуждениях.
              Роли разговаривают по-разному и открывают разные опции.
              На техкоме будет мини-защита: “что делаем / зачем / почему сейчас”.
            </p>
            <div class="actions">
              <button class="choice" id="btnNew">Новая миссия</button>
              <button class="choice" id="btnContinue">Продолжить</button>
              <button class="choice" id="btnResetSave">Стереть сохранение</button>
            </div>
            <div class="small">Сохранение происходит автоматически после каждого выбора.</div>
          </div>
          <div class="box">
            <h3>Параметры</h3>
            <p>
              <b>Фокус</b> — ясность и энергия. Когда падает, начинаются “не так поняли”.<br>
              <b>Стресс</b> + <b>Скоуп</b> раздувают шум и шанс внезапных “пожаров”.<br>
              <b>Репутация</b> помогает проходить узкие места и договариваться.
            </p>
            <div class="small">Если Creep-meter “проснулся” — всё чаще прилетают срочные сюрпризы.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="gameTitle">CBONDS: Орбитальный Бэклог</h1>
          <div class="subtitle" id="gameSub">космическая история про решения и последствия</div>
        </div>
      </div>

      <div class="top-right">
        <div class="pill" id="pillRole"><span class="dot"></span><span>Роль: <b id="stRole">—</b></span></div>
        <div class="pill" id="pillDay"><span class="dot"></span><span>День: <b id="stDay">1</b></span></div>
        <div class="pill" id="pillBudget"><span class="dot"></span><span>Бюджет: <b id="stBudget">100</b></span></div>
        <div class="pill" id="pillStress"><span class="dot"></span><span>Стресс: <b id="stStress">0</b></span></div>
        <div class="pill" id="pillScope"><span class="dot"></span><span>Скоуп: <b id="stScope">1</b></span></div>
        <div class="pill"><span class="dot"></span><span>Фокус: <b id="stFocus">100</b></span></div>
      </div>
    </header>

    <div class="grid">
      <section class="card" id="mainCard">
        <div class="art">
          <div class="glow"></div>
          <svg viewBox="0 0 1200 240" preserveAspectRatio="none" aria-hidden="true">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="rgba(255,255,255,.20)"/>
                <stop offset="1" stop-color="rgba(255,255,255,0)"/>
              </linearGradient>
              <filter id="blur"><feGaussianBlur stdDeviation="4"/></filter>
            </defs>
            <path d="M0,180 C140,120 260,210 420,150 C580,90 690,200 860,140 C1020,90 1120,160 1200,120 L1200,240 L0,240 Z"
                  fill="rgba(0,0,0,.18)"/>
            <path d="M0,150 C150,100 280,210 440,150 C610,85 730,210 900,140 C1050,95 1140,130 1200,95"
                  stroke="rgba(255,255,255,.22)" stroke-width="2" fill="none"/>
            <g filter="url(#blur)" opacity=".85">
              <circle cx="180" cy="90" r="22" fill="url(#g1)"/>
              <circle cx="520" cy="70" r="28" fill="url(#g1)"/>
              <circle cx="860" cy="82" r="24" fill="url(#g1)"/>
            </g>
          </svg>
        </div>

        <div class="card-inner">
          <div class="scene-head">
            <div>
              <h2 class="scene-title" id="nodeTitle">Загрузка…</h2>
              <div class="tiny" id="nodeMeta"></div>
            </div>
            <div class="badge" id="nodeBadge">—</div>
          </div>

          <p class="scene-text" id="nodeText"></p>
          <div class="whisper" id="whisper" hidden></div>

          <div class="choices" id="choices"></div>

          <div class="row">
            <button class="ghost" id="restartBtn" type="button">Новая миссия</button>
            <button class="ghost" id="continueBtn" type="button">Продолжить</button>
            <button class="ghost" id="backBtn" type="button" disabled>Шаг назад</button>
            <button class="ghost" id="skipBtn" type="button">Пропустить печать</button>
          </div>

          <div class="tiny" style="margin-top:10px;">
            Редактирование: все сцены и ветки лежат в объекте <code>story</code>.
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="card-inner">
          <div class="panel-title">
            <h2>Панель станции</h2>
            <div class="tiny">
              <label style="display:inline-flex; gap:8px; align-items:center; cursor:pointer;">
                <input type="checkbox" id="audioToggle" checked />
                звук
              </label>
              &nbsp;·&nbsp;
              <label style="display:inline-flex; gap:8px; align-items:center; cursor:pointer;">
                <input type="checkbox" id="typeToggle" checked />
                печать
              </label>
            </div>
          </div>

          <div class="meter">
            <div class="meter-top">
              <div style="font-weight:900;">Creep-meter</div>
              <div class="tiny" id="creepLabel">спокоен</div>
            </div>
            <div class="bar"><div id="creepBar"></div></div>
            <div class="tiny" id="creepHint" style="margin-top:8px;">
              Стресс + скоуп + низкий фокус повышают “шум космоса”.
            </div>
          </div>

          <div class="kv">
            <div class="k">
              <div class="lbl">Риск срыва</div>
              <div class="val" id="riskVal">низкий</div>
            </div>
            <div class="k">
              <div class="lbl">Репутация</div>
              <div class="val" id="repVal">ровная</div>
            </div>
          </div>

          <div class="map">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <div style="font-weight:900; font-size:12px;">Прогресс миссии</div>
              <div class="tiny"><span id="stepsNow">0</span>/<span id="stepsMax">18</span></div>
            </div>
            <div class="dots" id="dots"></div>
          </div>

          <details open>
            <summary>Журнал решений</summary>
            <div class="log" id="log"></div>
          </details>

          <details>
            <summary>Направление исполнения</summary>
            <div class="tiny" id="deptHint" style="margin-top:10px; line-height:1.6;">
              Подразделение ещё не назначено.
            </div>
          </details>
        </div>
      </aside>
    </div>
  </div>

<script>
/** ======================
 *  STORY (Cbonds + космос) v2
 *  Цели v2:
 *  - + роли: Развитие и Руководство
 *  - живые реплики (не “описание процесса”)
 *  - те же механики: техком-минизащита, dept-ветки, save/continue
 *  ====================== */

const story = {
  meta: {
    title: "CBONDS: Орбитальный Бэклог — v2",
    subtitle: "живые диалоги, реальные решения, космос и последствия",
    maxSteps: 18,
    whispers: [
      "Если задача звучит “понятно”, значит мы ещё не начали уточнять.",
      "Самое опасное слово — “быстро”. Второе — “почти готово”.",
      "Приоритет — это не число. Это настроение станции.",
      "Скоуп расширяется тихо, пока вы не заметите лишний модуль на корпусе.",
      "Dev — репетиция. Prod — премьера без возможности “сейчас поправим”.",
      "Если все согласились слишком быстро — вы что-то упустили."
    ],
    randomEvents: [
      { id:"client_ping", chance: 0.14, text:"Из эфира: «Клиент просит апдейт. Сейчас».", delta:{ stress:+2, focus:-6 } },
      { id:"priority_flip", chance: 0.12, text:"Кто-то в навигации поменял приоритеты местами. “Ненадолго”.", delta:{ stress:+1, scope:+1 } },
      { id:"incident", chance: 0.09, text:"Срочная авария: метеорный мусор попал в сервисный отсек. Часть планов улетела.", delta:{ stress:+3, scope:+1, focus:-8 } },
      { id:"rare_alignment", chance: 0.11, text:"Редкость: техлиды сходятся во мнении и предлагают адекватный план.", delta:{ stress:-2, focus:+6, rep:+1 } },
    ],
  },

  initialState: {
    day: 1, budget: 100, stress: 0, scope: 1, focus: 100, rep: 0, steps: 0,
    role: "—", // Продажи | Database | PO | Развитие | Руководство
    quiz: { active:false, q:0, score:0, total:0, onFailNext:"", onPassNext:"" },
    flags: {
      decision:"",
      routedToDevDept:"",
      returnedForClarification:false,
      estimateSmall:false,
      estimateLarge:false,
      inSprint:false,
      sprintTweaked:false,
      sprintCut:false,
      onDev:false,
      bugsFound:false,
      onProd:false,
      done:false,
      creepAwake:false
    }
  },

  nodes: {
    prologue: {
      chapter: 0,
      title: "Кто вы на станции?",
      text:
`Станция CBONDS-1 дрейфует на орбите рынка.
На борту — люди, процессы и задачи, которые почему-то всегда “на вчера”.

Выберите роль. Она влияет на доступные реплики и на то, что вам будут “прощать”.`,
      choices: [
        { label:"Продажи — я слышу клиента первым, и у меня горит чат", next:"start", delta:{ rep:+1, stress:+1 }, setRole:"Продажи" },
        { label:"Database — я люблю факты, цифры и “давайте воспроизведём”", next:"start", delta:{ rep:+1, focus:-2 }, setRole:"Database" },
        { label:"Product Owner — я держу ниточки, пока их не стало слишком много", next:"start", delta:{ rep:+2, stress:+1, focus:-2 }, setRole:"PO" },
        { label:"Отдел развития — “погодите, а проблему мы точно поняли?”", next:"start", delta:{ rep:+2, focus:-3 }, setRole:"Развитие" },
        { label:"Руководство — я думаю рисками, эффектом и тем, что будет через квартал", next:"start", delta:{ rep:+3, stress:+1 }, setRole:"Руководство" },
      ]
    },

    start: {
      chapter: 1,
      title: "Входящий сигнал",
      text:
`На панели мигает новое сообщение.

Продажи: «Клиент сказал: “у конкурентов есть, а у нас нет”. И спрашивает, когда будет».
Database: «Уточните, что именно “есть”. Они каждый раз разное имеют в виду».

На фоне кто-то тихо шутит: “космос холодный — но чат ещё холоднее”.

Что вы делаете первым?`,
      choices: [
        { label:"Спросить: “А что клиент пытался сделать по шагам?”", next:"clarify_need", delta:{ focus:-3, rep:+1 } },
        { label:"Сказать продажам: “Дайте клиенту мягкий апдейт — мы разбираемся”", next:"soft_update", delta:{ stress:+1, scope:+1 } },
        { label:"Сразу собрать один экран: проблема → эффект → вариант решения", next:"onepager", delta:{ day:+1, focus:-4, rep:+2 } },
        { label:"Если вы Руководство: “Окей. Что теряем, если не сделаем?”", next:"exec_frame", delta:{ stress:+1, rep:+2 }, req:{ roleIs:"Руководство" } },
        { label:"Если вы Развитие: “Стоп. А это точно задача, а не исследование?”", next:"dev_frame", delta:{ focus:-2, rep:+1 }, req:{ roleIs:"Развитие" } },
      ]
    },

    exec_frame: {
      chapter: 1,
      title: "Рамка руководства",
      text:
`Вы задаёте вопрос, после которого люди чуть ровнее садятся на стульях:
— “Какая цена бездействия?”

В чате появляется:
— “клиент большой / клиент шумный / клиент стратегический” (нужное подчеркнуть).`,
      choices: [
        { label:"Попросить конкретику: “сколько это денег/риска/репутации?”", next:"clarify_need", delta:{ focus:-3, rep:+1 } },
        { label:"Сказать: “Сформулируйте вариант MVP, иначе это не полетит”", next:"onepager", delta:{ day:+1, rep:+2, focus:-3 } },
      ]
    },

    dev_frame: {
      chapter: 1,
      title: "Рамка развития",
      text:
`Вы слышите запрос и автоматически переводите его на человеческий язык:
— “Они хотят кнопку? Или они хотят перестать страдать?”

Половина задач умирает на этом вопросе.
Вторая половина — наконец становится понятной.`,
      choices: [
        { label:"Попросить пример/скрин/тикер/ISIN и контекст использования", next:"evidence", delta:{ day:+1, focus:-3, rep:+2 } },
        { label:"Сформулировать гипотезу и минимальный эксперимент (быстро и честно)", next:"mini_experiment", delta:{ day:+1, focus:-4, rep:+2 } },
      ]
    },

    clarify_need: {
      chapter: 1,
      title: "Уточнение смысла",
      text:
`Вы пишете в чат:
— “Дайте, пожалуйста: кто пользователь, что делает, где ломается, какой ожидаемый результат”.
В ответ приходит… голосовое на 3 минуты и скрин без подписи.

Классика.

Как вы спасаете ситуацию?`,
      choices: [
        { label:"Спокойно: “Ок. Давайте один конкретный кейс и один ожидаемый итог”", next:"evidence", delta:{ day:+1, focus:-4, rep:+2 } },
        { label:"Сказать: “Понял, попробуем быстро” (опасная магия)", next:"danger_promise", delta:{ stress:+2, scope:+1, rep:-1 }, setFlags:{ creepAwake:true } },
        { label:"Если Database: “Скиньте исходные данные — иначе это разговоры”", next:"evidence", delta:{ day:+1, focus:-3, rep:+2 }, req:{ roleIs:"Database" } },
        { label:"Если Продажи: “Я в эфире. Дайте хоть что-то, что можно обещать”", next:"soft_update", delta:{ stress:+2, rep:+1 }, req:{ roleIs:"Продажи" } },
      ]
    },

    soft_update: {
      chapter: 1,
      title: "Апдейт клиенту",
      text:
`Вы даёте клиенту “парашют”:
— “Мы посмотрели, вернёмся с апдейтом”.

Это снижает давление… и повышает ожидания.

Теперь надо быстро сделать главное: понять, что именно вы поняли.`,
      choices: [
        { label:"Собрать доказательства и один понятный пример", next:"evidence", delta:{ day:+1, focus:-4, rep:+1 } },
        { label:"Сразу упаковать на “Совет командования” (без идеала, но с шансом)", next:"council_room", delta:{ day:+1, stress:+1, focus:-5 }, setFlags:{ creepAwake:true } },
      ]
    },

    onepager: {
      chapter: 1,
      title: "One-pager",
      text:
`Вы делаете то, что потом спасает нервы:
одна страница, без воды:
— что болит
— кого бесит
— что меняем
— что станет лучше
— как понять, что получилось`,
      choices: [
        { label:"Пойти с этим на Совет командования", next:"council_room", delta:{ day:+1, focus:-3, rep:+2 } },
        { label:"Сначала прикинуть “в какую сторону это вообще” (UI/API/данные/архитектура)", next:"triage", delta:{ day:+1, focus:-4, rep:+1 } },
      ]
    },

    mini_experiment: {
      chapter: 1,
      title: "Мини-эксперимент",
      text:
`Вы предлагаете: “Давайте сделаем маленькое, чтобы проверить, что мы вообще туда копаем”.
Это звучит разумно. И опасно. Потому что “маленькое” часто растёт.`,
      choices: [
        { label:"Ограничить эксперимент жёстко: 1 сценарий, 1 метрика, 1 неделя", next:"council_room", delta:{ day:+1, rep:+2, scope:-1 } },
        { label:"Оставить “пока маленькое” без рамок (шанс раздува)", next:"council_room", delta:{ day:+1, rep:+1, scope:+1 }, setFlags:{ creepAwake:true } },
      ]
    },

    evidence: {
      chapter: 1,
      title: "Артефакты",
      text:
`Вы собираете “железо”:
пример, шаги, ожидаемое поведение, и что будет считаться победой.

Станция выдыхает. Теперь можно идти к тем, кто любит решать.`,
      choices: [
        { label:"Вынести на Совет командования", next:"council_room", delta:{ day:+1, rep:+2, focus:-3 } },
        { label:"Если вы Развитие: добавить вариант “как сделать проще и не потерять смысл”", next:"council_room", delta:{ day:+1, rep:+3, focus:-4 }, req:{ roleIs:"Развитие" } },
      ]
    },

    danger_promise: {
      chapter: 1,
      title: "Опасное “быстро”",
      text:
`Вы произнесли заклинание “сделаем быстро”.
Станция тихо записала это в долговую книгу.

Теперь любое “не успели” будет звучать как “не хотели”.`,
      choices: [
        { label:"Немедленно упаковать всё и бежать на Совет", next:"council_room", delta:{ day:+1, stress:+1, focus:-6 } },
        { label:"Попробовать протолкнуть напрямую в IT (сэкономить круг)", next:"shortcut", delta:{ stress:+2, rep:-1, scope:+1 }, setFlags:{ creepAwake:true } },
      ]
    },

    council_room: {
      chapter: 2,
      title: "Совет командования",
      text:
`Комната управления. Здесь любят две вещи:
1) ясность
2) последствия

В воздухе висит вопрос:
— “Мы это делаем… или это очередная красивая мысль?”`,
      choices: [
        { label:"Сказать коротко: “Вот боль → вот эффект → вот как проверим результат”", next:"council_decision", delta:{ stress:+1, focus:-4, rep:+2 } },
        { label:"Начать издалека (и потерять аудиторию на второй минуте)", next:"council_decision", delta:{ stress:+2, focus:-6, rep:-1 }, setFlags:{ returnedForClarification:true } },
        { label:"Если Руководство: “Ок, делаем, но только MVP. Без сюрпризов.”", next:"council_decision", delta:{ stress:+1, rep:+3, scope:-1 }, req:{ roleIs:"Руководство" } },
        { label:"Если Продажи: “Если мы это не сделаем, клиент начнёт сравнивать вслух”", next:"council_decision", delta:{ stress:+2, rep:+2, scope:+1 }, req:{ roleIs:"Продажи" }, setFlags:{ creepAwake:true } },
      ]
    },

    council_decision: {
      chapter: 2,
      title: "Решение",
      text:
`Решение принято.

Но в космосе есть закон: приоритет живёт своей жизнью.

Куда вы отправляете задачу дальше?`,
      choices: [
        { label:"Окей, делаем. Дальше — маршрутизация", next:"routing", delta:{ rep:+1 } },
        { label:"“Потом”. Поставим в дальний отсек", next:"later", delta:{ stress:+1, rep:-1 } },
        { label:"“Нет”. Лучше честно закрыть, чем тянуть", next:"nope", delta:{ stress:+1, rep:-1 } },
      ]
    },

    later: {
      chapter: 2,
      title: "Дальний отсек “потом”",
      text:
`Задача уехала в отсек “потом”.
Там тепло, темно и много легенд.

Хотите попытаться вытащить её обратно?`,
      choices: [
        { label:"Собрать новый аргумент/кейс и вернуться на следующий Совет", next:"evidence", delta:{ day:+2, stress:+1, focus:-6, rep:+1 } },
        { label:"Принять и закрыть историю", next:"ending_eternal", ending:true },
      ]
    },

    nope: {
      chapter: 2,
      title: "Отказ",
      text:
`Вы смотрите на запрос и понимаете:
это не про продукт. Это про ожидания.

Иногда лучший релиз — вежливое “нет”.`,
      choices: [
        { label:"Ответить клиенту честно и аккуратно", next:"ending_neutral", ending:true },
        { label:"Если Развитие: “А давайте предложим другой путь (не кодом)”", next:"alt_solution", delta:{ rep:+2, focus:-3 }, req:{ roleIs:"Развитие" } },
      ]
    },

    alt_solution: {
      chapter: 2,
      title: "Альтернатива",
      text:
`Вы предлагаете вариант без разработки:
настройка, документация, новый шаблон, маленький workaround.

Это не выглядит героически. Зато работает.`,
      choices: [
        { label:"Отдать в продажи как решение и закрыть", next:"ending_neutral", delta:{ rep:+1 }, ending:true },
        { label:"Всё равно попробовать MVP как код (и рискнуть)", next:"routing", delta:{ stress:+1, scope:+1 }, setFlags:{ creepAwake:true } },
      ]
    },

    routing: {
      chapter: 3,
      title: "Куда летит задача?",
      text:
`Дальше начинается реальность.
Есть два типа задач:
— “надо подумать”
— “можно сделать”

Вы выбираете маршрут.`,
      choices: [
        { label:"Это “надо подумать” → в отдел развития", next:"dev_gate", delta:{ day:+1, stress:+1, focus:-4 } },
        { label:"Это “можно сделать” → на техком IT", next:"techcom_intro", delta:{ day:+1, stress:+1, focus:-4 } },
        { label:"Если Руководство: “На техком. И давайте без философии.”", next:"techcom_intro", delta:{ day:+1, rep:+2, stress:+1 }, req:{ roleIs:"Руководство" } },
      ]
    },

    dev_gate: {
      chapter: 3,
      title: "Отдел развития",
      text:
`В отделе развития задают неприятные, но полезные вопросы.

— “Если мы это сделаем, что перестанет болеть?”
— “А что будет, если сделаем не так?”

И вы внезапно понимаете, что половина “хочу кнопку” — это “хочу спокойствие”.`,
      choices: [
        { label:"Принести чёткую гипотезу + ограничение по объёму", next:"dev_accept", delta:{ day:+2, rep:+2, focus:-4 } },
        { label:"Принести “ну вы сами понимаете” (и получить возврат)", next:"dev_accept", delta:{ day:+2, rep:-1, focus:-6, stress:+2 }, setFlags:{ returnedForClarification:true } },
        { label:"Если Развитие: “Ок, я сам/сама это упакую нормально”", next:"dev_accept", delta:{ day:+2, rep:+3, focus:-5 }, req:{ roleIs:"Развитие" } },
      ]
    },

    dev_accept: {
      chapter: 3,
      title: "Вердикт развития",
      text:
`Либо берут на проработку, либо отправляют вас “допонять”.

Сейчас решается, будет ли у задачи шанс попасть в IT без вечного “уточните”.`,
      choices: [
        { label:"Приняли. Дальше — дождаться разложения на IT-задачи", next:"dev_wait", delta:{ day:+3, stress:+1, focus:-8, rep:+1 } },
        { label:"Вернули на уточнение. Ок. Собираем факты и заново", next:"evidence", delta:{ day:+2, stress:+1, focus:-6 }, setFlags:{ returnedForClarification:true } },
      ]
    },

    dev_wait: {
      chapter: 4,
      title: "Ожидание",
      text:
`Проработка идёт.
Вы открываете чат и видите… тишину.

Тишина может означать “работаем”.
Или “ой”.`,
      choices: [
        { label:"Пингнуть мягко: “как дела, есть черновик постановки?”", next:"techcom_intro", delta:{ day:+2, stress:+1, focus:-6, rep:+1 } },
        { label:"Подождать ещё (и рискнуть улететь в “потом”)", next:"later", delta:{ day:+3, stress:+1, focus:-8 }, setFlags:{ creepAwake:true } },
      ]
    },

    techcom_intro: {
      chapter: 4,
      title: "Техком IT",
      text:
`Комната техкома. Слышно, как шуршит здравый смысл.

Три вопроса, три выстрела:
1) Что делаем?
2) Зачем?
3) Почему сейчас?

Если поплывёте — вас аккуратно отправят “подумать ещё”.`,
      choices: [
        { label:"Начать защиту", next:"techcom_q1", delta:{ stress:+1, focus:-3 } },
        { label:"Сказать: “Подождите, я принесу конкретику”", next:"evidence", delta:{ day:+1, stress:+1, focus:-4, rep:+1 } },
        { label:"Если Руководство: “Ребята, без лирики. MVP и сроки.”", next:"techcom_q1", delta:{ stress:+1, rep:+2 }, req:{ roleIs:"Руководство" } },
      ]
    },

    techcom_q1: {
      chapter: 4,
      title: "Техком: 1/3",
      text: `Вопрос 1: Окей. Что именно меняем? (без “ну там”)`,
      quiz: {
        total: 3,
        questions: [
          {
            q: "1) Что меняем?",
            options: [
              { label:"“На экране X добавляем Y, в API Z меняем ответ, критерий — вот”", score:+1 },
              { label:"“Сделайте, чтобы было удобнее. Вы же понимаете…”", score:0 },
              { label:"“Это сложно объяснить, но надо срочно”", score:-1 },
            ]
          },
          {
            q: "2) Зачем?",
            options: [
              { label:"“Сэкономим N минут/уменьшим ошибки/закроем кейс клиента — измеримо”", score:+1 },
              { label:"“Потому что клиент так сказал”", score:0 },
              { label:"“Потому что все так делают”", score:-1 },
            ]
          },
          {
            q: "3) Почему сейчас?",
            options: [
              { label:"“Есть дедлайн/обязательство/риск, и он понятен”", score:+1 },
              { label:"“Ну… потому что вчера”", score:0 },
              { label:"“Потому что иначе всё пропадёт” (без фактов)", score:-1 },
            ]
          },
        ],
        onPassNext: "analysis",
        onFailNext: "techcom_fail"
      },
      choices: [
        { label:"Ответить чётко (и без лишних эмоций)", next:"techcom_answer", quizPick:{ qIndex:0, optIndex:0 }, delta:{ rep:+1 } },
        { label:"Ответить общими словами (на авось)", next:"techcom_answer", quizPick:{ qIndex:0, optIndex:1 }, delta:{ stress:+1 } },
        { label:"Ответить “срочно, потом объясню”", next:"techcom_answer", quizPick:{ qIndex:0, optIndex:2 }, delta:{ stress:+2 }, setFlags:{ creepAwake:true } },
      ]
    },

    techcom_q2: {
      chapter: 4,
      title: "Техком: 2/3",
      text: `Вопрос 2: Зачем это нужно? (в идеале так, чтобы это можно было померить)`,
      choices: [
        { label:"Показать эффект: “вот где теряем время/ошибаемся/злим клиента”", next:"techcom_answer", quizPick:{ qIndex:1, optIndex:0 }, delta:{ rep:+1 } },
        { label:"Сказать: “Клиент просит”", next:"techcom_answer", quizPick:{ qIndex:1, optIndex:1 }, delta:{ stress:+1 } },
        { label:"Сказать: “Так надо”", next:"techcom_answer", quizPick:{ qIndex:1, optIndex:2 }, delta:{ stress:+2 }, setFlags:{ creepAwake:true } },
      ]
    },

    techcom_q3: {
      chapter: 4,
      title: "Техком: 3/3",
      text: `Вопрос 3: Почему сейчас? (и почему не “потом когда-нибудь”)`,
      choices: [
        { label:"Назвать факт: дедлайн/обязательство/риск, который реально наступит", next:"techcom_answer", quizPick:{ qIndex:2, optIndex:0 }, delta:{ rep:+1 } },
        { label:"Сказать “потому что вчера”", next:"techcom_answer", quizPick:{ qIndex:2, optIndex:1 }, delta:{ stress:+1 } },
        { label:"Сказать “иначе всё пропадёт” без фактов", next:"techcom_answer", quizPick:{ qIndex:2, optIndex:2 }, delta:{ stress:+2 }, setFlags:{ creepAwake:true } },
      ]
    },

    techcom_answer: {
      chapter: 4,
      title: "Техком фиксирует ответ",
      text: `(служебный шаг)`,
      choices: [{ label:"Дальше", next:"techcom_next", delta:{} }]
    },

    techcom_next: {
      chapter: 4,
      title: "Продолжение",
      text: `(служебный шаг)`,
      choices: [{ label:"Продолжить", next:"techcom_next", delta:{} }]
    },

    techcom_fail: {
      chapter: 4,
      title: "Техком: неубедительно",
      text:
`В комнате наступает пауза, после которой обычно говорят что-то вроде:
— “Давайте вы это уточните… и вернётесь”.

Это не злость. Это защита станции от хаоса.`,
      choices: [
        { label:"Вернуться и добить конкретику (да, снова)", next:"evidence", delta:{ day:+1, stress:+2, focus:-6, rep:-1 }, setFlags:{ returnedForClarification:true } },
        { label:"Если Развитие: “Ок, я упакую постановку и принесу вам нормальный текст”", next:"evidence", delta:{ day:+1, rep:+2, focus:-5 }, req:{ roleIs:"Развитие" } },
        { label:"Сдаться и отправить в “потом”", next:"ending_eternal", ending:true },
      ]
    },

    analysis: {
      chapter: 5,
      title: "Технический анализ",
      text:
`Окей, задачу приняли.
Теперь мы выясняем:
— куда она ляжет
— какие ограничения
— где может взорваться
— сколько это вообще стоит`,
      choices: [
        { label:"Назначить направление исполнения", next:"dept", delta:{ day:+1, stress:+1, focus:-3, rep:+1 } },
        { label:"Понять, что снова не хватает деталей → уточнить", next:"evidence", delta:{ day:+1, stress:+2, focus:-8, rep:-1 }, setFlags:{ returnedForClarification:true } },
      ]
    },

    dept: {
      chapter: 5,
      title: "Кому это делать?",
      text:
`Вы выбираете направление. Это влияет на риски и на возможные “подлянки” на dev/prod.`,
      choices: [
        { label:"Фронт (интерфейсы и UX)", next:"estimate", delta:{ stress:+1 }, setDept:"front" },
        { label:"Бэк (API/логика/интеграции)", next:"estimate", delta:{ stress:+1 }, setDept:"back" },
        { label:"Данные (выгрузки/потоки/ETL)", next:"estimate", delta:{ stress:+2 }, setDept:"data" },
        { label:"Дизайн (макеты/состояния/полировки)", next:"estimate", delta:{ stress:+1, budget:-4 }, setDept:"design" },
        { label:"Архитектура (системные изменения)", next:"estimate", delta:{ stress:+2, focus:-4 }, setDept:"arch" },
      ]
    },

    estimate: {
      chapter: 5,
      title: "Оценка",
      text:
`Вам приносят оценку.
Вы смотрите на неё и сразу понимаете, будет ли это “в этой жизни” или “легенда станции”.`,
      choices: [
        { label:"Оценка небольшая — есть шанс быстро довезти", next:"sprint", delta:{ day:+1, stress:+1, focus:-3 }, setFlags:{ estimateSmall:true } },
        { label:"Оценка большая — надо резать/дробить/или ждать", next:"big", delta:{ day:+1, stress:+2, focus:-4 }, setFlags:{ estimateLarge:true, creepAwake:true } },
        { label:"Если Руководство: “Режем до MVP. Без вариантов.”", next:"sprint", delta:{ day:+1, rep:+2, scope:-1, stress:+1 }, req:{ roleIs:"Руководство" }, setFlags:{ estimateSmall:true } },
      ]
    },

    big: {
      chapter: 5,
      title: "Большая оценка",
      text:
`Большая оценка — это не “плохо”.
Это “вы сейчас купите целую отдельную историю”.

Что делаем?`,
      choices: [
        { label:"Разбить на этапы: MVP сейчас, остальное потом", next:"sprint", delta:{ scope:-1, rep:+1, stress:+1 }, setFlags:{ estimateSmall:true } },
        { label:"Пойти как есть и попытаться выбить место (удачи)", next:"sprint", delta:{ stress:+1, focus:-4 }, setFlags:{ creepAwake:true } },
        { label:"Отправить в дальний отсек “потом”", next:"ending_eternal", ending:true },
      ]
    },

    sprint: {
      chapter: 6,
      title: "Сборка полётного плана",
      text:
`Собирают спринт.
На столе — список задач и очень ограниченное количество “живых часов”.

Здесь всё решают две вещи:
— насколько вы понятны
— насколько вы опасны, если вас не взять`,
      choices: [
        { label:"Защитить и выбить место в спринте", next:"in_sprint", delta:{ stress:+2, focus:-6, rep:+2 }, setFlags:{ inSprint:true } },
        { label:"Не выбить — пережить это и идти в следующий цикл", next:"tweak", delta:{ day:+7, stress:+1, focus:-6, rep:-1 }, setFlags:{ creepAwake:true } },
        { label:"Согласиться на компромисс: урезать объём, но попасть", next:"in_sprint", delta:{ scope:-1, stress:+1, rep:+1 }, setFlags:{ inSprint:true } },
      ]
    },

    tweak: {
      chapter: 6,
      title: "Корректировки",
      text:
`После сборки есть маленькое окно, когда можно попросить “передвинуть”.
Иногда — получается. Иногда — вы слышите тишину.

Какая ваша стратегия?`,
      choices: [
        { label:"Попросить корректировку аккуратно и по делу", next:"tweak2", delta:{ day:+2, stress:+1, focus:-4 } },
        { label:"Промолчать и ждать следующую сборку", next:"sprint", delta:{ day:+12, stress:+1, focus:-6 } },
        { label:"Если Продажи: “Мне нужен апдейт для клиента. Помогите включить”", next:"tweak2", delta:{ day:+2, rep:+1, stress:+2 }, req:{ roleIs:"Продажи" } },
      ]
    },

    tweak2: {
      chapter: 6,
      title: "Ответ на просьбу",
      text:
`Вы отправили сообщение.
Теперь два возможных исхода: “ок” или “в следующий раз”.

Как в космосе: либо пристыковались, либо пролетели мимо.`,
      choices: [
        { label:"Получилось! Задача в спринте", next:"in_sprint", delta:{ rep:+2, stress:+1 }, setFlags:{ inSprint:true, sprintTweaked:true } },
        { label:"Не получилось. Возвращаемся в очередь", next:"sprint", delta:{ rep:-1, stress:+1, focus:-3 } },
      ]
    },

    in_sprint: {
      chapter: 7,
      title: "Старт спринта",
      text:
`Спринт начался.
В голове звучит мысль: “главное — чтобы не прилетело ничего срочного”.

Именно в этот момент обычно что-то срочное и прилетает.`,
      choices: [
        { label:"Спокойно начать: демо/план/передача в разработку", next:"dev_work", delta:{ day:+1, stress:+1, focus:-4 } },
        { label:"Влетает срочная авария и съедает ресурсы", next:"incident", delta:{ stress:+3, focus:-8 }, setFlags:{ creepAwake:true } },
        { label:"Задачу выкинули из спринта (да, бывает)", next:"cut", delta:{ stress:+2, rep:-1 }, setFlags:{ sprintCut:true } },
      ]
    },

    incident: {
      chapter: 7,
      title: "Срочный инцидент",
      text:
`Пожар тушат все. Плановые задачи отъезжают.
Вы смотрите на спринт и понимаете: “мы снова играем на выживание”.`,
      choices: [
        { label:"Пережить и вернуться к планированию", next:"sprint", delta:{ day:+5, stress:+2, focus:-8 } },
        { label:"Использовать инцидент как аргумент: “нам нужно укрепить этот узел”", next:"sprint", delta:{ rep:+1, stress:+1 } },
      ]
    },

    cut: {
      chapter: 7,
      title: "Исключили из спринта",
      text:
`Это неприятно.
Но хуже — делать вид, что это не неприятно.

Вы собираете себя в кучку и выбираете следующий ход.`,
      choices: [
        { label:"Вернуться в борьбу на следующей сборке", next:"sprint", delta:{ day:+12, stress:+1, focus:-6 } },
        { label:"Если Руководство: “Ок. Переформулируем цель и вернёмся сильнее”", next:"onepager", delta:{ day:+1, rep:+2, focus:-4 }, req:{ roleIs:"Руководство" } },
      ]
    },

    dev_work: {
      chapter: 8,
      title: "Разработка",
      text:
`Разработчик берёт задачу.
Через какое-то время прилетает сообщение:
— “Сделал. Проверьте на dev”.

Самое спокойное слово “dev” обычно значит:
“перед продом будет сюрприз”.`,
      choices: [
        { label:"Тестировать на dev строго по критериям", next:"dev_test", delta:{ day:+2, stress:+1, focus:-4, rep:+1 }, setFlags:{ onDev:true } },
        { label:"Сэкономить на тестах: “вроде ок, катим” (опасно)", next:"prod", delta:{ day:+1, stress:+2, focus:-6, rep:-1 }, setFlags:{ onDev:true, creepAwake:true } },
        { label:"Если данные: заложить контрольные выборки и сверки до prod", next:"dev_test", delta:{ day:+1, rep:+2, stress:+1 }, req:{ deptIs:"data" }, setFlags:{ onDev:true } },
      ]
    },

    dev_test: {
      chapter: 9,
      title: "Проверка на dev",
      text:
`Вы проверяете. И, конечно же, что-то “чуть-чуть не так”.
Иногда это “чуть-чуть” занимает два дня.

Что вы находите?`,
      choices: [
        { label:"Нашли баг/расхождение — возвращаем в доработку", next:"loop", delta:{ day:+1, stress:+2, focus:-5 }, setFlags:{ bugsFound:true } },
        { label:"Выглядит хорошо — можно выпускать на prod", next:"prod", delta:{ day:+1, stress:+1, focus:-3, rep:+1 } },
        { label:"Если фронт: попросить дизайн-взгляд на состояния перед релизом", next:"prod", delta:{ day:+1, rep:+1, stress:+1 }, req:{ deptIs:"front" } },
      ]
    },

    loop: {
      chapter: 9,
      title: "Цикл доработок",
      text:
`Доработка → dev → проверка.
Станция любит циклы.
Особенно те, которые “ещё один раз и точно всё”.`,
      choices: [
        { label:"Проверить снова на dev", next:"dev_test", delta:{ day:+1, stress:+1, focus:-3 } },
        { label:"Ладно. Катим на prod (с риском)", next:"prod", delta:{ day:+1, stress:+2, rep:-1 }, setFlags:{ creepAwake:true } },
      ]
    },

    prod: {
      chapter: 10,
      title: "Prod",
      text:
`Prod — открытый космос.
Если что-то пошло не так — это уже не “ой”, это “почему”.

Как проходит релиз?`,
      choices: [
        { label:"Всё хорошо — закрываем задачу", next:"done", delta:{ day:+1, stress:-2, rep:+2, focus:+6 }, setFlags:{ onProd:true, done:true } },
        { label:"Не всё хорошо — назад в цикл", next:"loop", delta:{ day:+1, stress:+2, focus:-6 }, setFlags:{ onProd:true, bugsFound:true } },
        { label:"Если архитектура: добавить доп. проверку/мониторинг и спасти релиз", next:"done", delta:{ day:+1, rep:+3, stress:-1 }, req:{ deptIs:"arch" }, setFlags:{ onProd:true, done:true } },
      ]
    },

    done: {
      chapter: 11,
      title: "Закрыто",
      text:
`Задача закрыта.
Ответственный обновляет клиентский запрос.
Продажи уходят в эфир: “готово”.

В этот момент космос снова становится тихим.
Ненадолго.`,
      choices: [
        { label:"Сообщить клиенту и красиво закрыть историю", next:"ending_win", delta:{ rep:+1 }, ending:true },
        { label:"Сделать короткий постмортем: что улучшить в следующий раз", next:"ending_best", delta:{ rep:+2, focus:+4 }, ending:true },
        { label:"Открыть следующий запрос (проверить судьбу)", next:"start", delta:{ day:+1, stress:+1, scope:+1 }, setFlags:{ creepAwake:true } },
      ]
    },

    shortcut: {
      chapter: 2,
      title: "Короткий путь",
      text:
`Вы пытаетесь сократить маршрут.
Иногда это работает.
Иногда вас догоняет вопрос: “а кто это решил?”`,
      choices: [
        { label:"Повезло: всё равно идём на техком, но быстрее", next:"techcom_intro", delta:{ day:+1, stress:+1, rep:+1 } },
        { label:"Не повезло: отправили “сначала в развитие”", next:"dev_gate", delta:{ day:+1, stress:+2, rep:-1 }, setFlags:{ creepAwake:true } },
      ]
    },

    ending_win: {
      chapter: 12,
      title: "Финал: миссия выполнена",
      text:
`Вы довезли задачу до prod и не развалили станцию.
Клиент получил результат. Команда выдохнула.

Где-то уже появляется новый сигнал.
И он будет звучать знакомо.`,
      ending:true
    },

    ending_best: {
      chapter: 12,
      title: "Финал: не просто сделали, а сделали лучше",
      text:
`Вы не только закрыли задачу, но и улучшили способ, которым станция работает.
Это редкий класс победы: системный.

Космос уважает такое.`,
      ending:true
    },

    ending_neutral: {
      chapter: 12,
      title: "Финал: честное “нет”",
      text:
`Вы закрыли запрос без лишнего героизма и без обещаний, которые потом больно.
Иногда это самое взрослое решение.

Станция цела. И это уже неплохо.`,
      ending:true
    },

    ending_eternal: {
      chapter: 12,
      title: "Финал: вечный отсек “потом”",
      text:
`Задача улетела в отсек “потом”.
Там ей тепло и спокойно. И немного грустно.

Иногда такие задачи возвращаются.
Чаще — становятся легендами станции.`,
      ending:true
    },
  }
};

/** =========================================
 *  ENGINE
 *  ========================================= */
const $ = (id)=>document.getElementById(id);

const el = {
  overlay: $("overlay"),
  btnNew: $("btnNew"),
  btnContinue: $("btnContinue"),
  btnResetSave: $("btnResetSave"),
  audioToggle2: $("audioToggle2"),
  typeToggle2: $("typeToggle2"),

  glitch: $("glitch"),
  title: $("gameTitle"),
  sub: $("gameSub"),

  nodeTitle: $("nodeTitle"),
  nodeText: $("nodeText"),
  nodeMeta: $("nodeMeta"),
  nodeBadge: $("nodeBadge"),
  whisper: $("whisper"),
  choices: $("choices"),

  restart: $("restartBtn"),
  continueBtn: $("continueBtn"),
  back: $("backBtn"),
  skip: $("skipBtn"),

  stRole: $("stRole"),
  stDay: $("stDay"),
  stBudget: $("stBudget"),
  stStress: $("stStress"),
  stScope: $("stScope"),
  stFocus: $("stFocus"),

  creepBar: $("creepBar"),
  creepLabel: $("creepLabel"),
  creepHint: $("creepHint"),
  riskVal: $("riskVal"),
  repVal: $("repVal"),

  dots: $("dots"),
  stepsNow: $("stepsNow"),
  stepsMax: $("stepsMax"),
  log: $("log"),

  audioToggle: $("audioToggle"),
  typeToggle: $("typeToggle"),

  pillRole: $("pillRole"),
  pillDay: $("pillDay"),
  pillBudget: $("pillBudget"),
  pillStress: $("pillStress"),
  pillScope: $("pillScope"),

  deptHint: $("deptHint"),
};

const SAVE_KEY = "cbonds_orbit_backlog_save_v2_final";

let state = structuredClone(story.initialState);
let currentId = "prologue";
let history = [];
let typing = { running:false, fullText:"", idx:0, timer:null };

const Audio = (() => {
  let ctx = null;
  function ensure(){
    if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
    return ctx;
  }
  function beep(freq=220, ms=40, type="sine", gain=0.025){
    if (!el.audioToggle.checked) return;
    const c = ensure();
    const o = c.createOscillator();
    const g = c.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(c.destination);
    o.start();
    o.stop(c.currentTime + ms/1000);
  }
  function click(){ beep(320, 28, "triangle", 0.02); }
  function bad(){ beep(120, 60, "sawtooth", 0.03); setTimeout(()=>beep(90, 70, "sawtooth", 0.025), 80); }
  function good(){ beep(520, 35, "sine", 0.02); setTimeout(()=>beep(680, 35, "sine", 0.018), 60); }
  return { click, bad, good };
})();

function clamp(n, a=-9999, b=9999){ return Math.max(a, Math.min(b, n)); }
function num(v){ return (typeof v==="number" && !Number.isNaN(v)) ? v : 0; }
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function applyDelta(delta){
  if (!delta) return;
  for (const [k, dv] of Object.entries(delta)){
    state[k] = clamp(num(state[k]) + num(dv));
  }
  state.focus = clamp(state.focus, 0, 120);
  state.stress = clamp(state.stress, 0, 30);
  state.scope = clamp(state.scope, 0, 30);
  state.budget = clamp(state.budget, -50, 999);
  state.rep = clamp(state.rep, -10, 10);
}

function setFlags(obj){
  if (!obj) return;
  for (const [k,v] of Object.entries(obj)){
    state.flags[k] = !!v;
  }
}
function setRole(role){
  state.role = role || "—";
}
function setDept(dept){
  state.flags.routedToDevDept = dept || "";
}

function creepScore(){
  const s = state.stress*3 + state.scope*2 + Math.max(0, 70 - state.focus)*0.6;
  const dept = state.flags.routedToDevDept;
  const amp = dept === "data" ? 6 : dept === "arch" ? 5 : dept === "back" ? 3 : dept === "front" ? 2 : 0;
  return clamp(Math.round(s + amp), 0, 100);
}

function labelRisk(){
  const c = creepScore();
  if (c < 28) return ["низкий", "ok"];
  if (c < 55) return ["средний", "warn"];
  return ["высокий", "bad"];
}
function labelRep(){
  if (state.rep >= 6) return "сильная";
  if (state.rep >= 2) return "ровная+";
  if (state.rep >= -1) return "ровная";
  if (state.rep >= -5) return "напряжённая";
  return "хрупкая";
}
function deptHuman(){
  const d = state.flags.routedToDevDept;
  if (d==="front") return "Фронт: риск “вроде красиво, но не так кликается”";
  if (d==="back") return "Бэк: риск “крайние случаи и интеграции”";
  if (d==="data") return "Данные: риск “точность, сверки и контрольные выборки”";
  if (d==="design") return "Дизайн: риск “состояния, согласование, полировка”";
  if (d==="arch") return "Архитектура: риск “зависимости и последствия”";
  return "Подразделение ещё не назначено.";
}

function setGlitch(on){
  if (!on) return;
  el.glitch.classList.remove("on");
  void el.glitch.offsetWidth;
  el.glitch.classList.add("on");
}

function stopTyping(){
  if (typing.timer) clearInterval(typing.timer);
  typing.running = false;
  typing.timer = null;
}

function typeText(full){
  stopTyping();
  typing.fullText = full;
  typing.idx = 0;
  el.nodeText.textContent = "";

  if (!el.typeToggle.checked){
    el.nodeText.textContent = full;
    return;
  }
  typing.running = true;
  typing.timer = setInterval(() => {
    typing.idx += 2;
    el.nodeText.textContent = typing.fullText.slice(0, typing.idx);
    if (typing.idx >= typing.fullText.length){
      stopTyping();
    }
  }, 12);
}

function meetsReq(req){
  if (!req) return true;
  if (req.dayMin != null && state.day < req.dayMin) return false;
  if (req.budgetMin != null && state.budget < req.budgetMin) return false;
  if (req.stressMax != null && state.stress > req.stressMax) return false;
  if (req.focusMin != null && state.focus < req.focusMin) return false;
  if (req.scopeMax != null && state.scope > req.scopeMax) return false;
  if (req.repMin != null && state.rep < req.repMin) return false;
  if (req.roleIs && state.role !== req.roleIs) return false;
  if (req.deptIs && state.flags.routedToDevDept !== req.deptIs) return false;
  return true;
}

function maybeWhisper(){
  const node = story.nodes[currentId];
  if (node?.ending) { el.whisper.hidden = true; return; }
  const list = story.meta.whispers || [];
  if (!list.length) { el.whisper.hidden = true; return; }

  const c = creepScore();
  const prob = c < 28 ? 0.35 : c < 55 ? 0.55 : 0.75;
  if (Math.random() > prob){ el.whisper.hidden = true; return; }
  const line = list[Math.floor(Math.random() * list.length)];
  el.whisper.textContent = line;
  el.whisper.hidden = false;
}

function maybeRandomEvent(){
  const node = story.nodes[currentId];
  if (node?.ending) return null;

  const events = story.meta.randomEvents || [];
  for (const e of events){
    const c = creepScore();
    const bonus = c >= 55 ? 0.06 : c >= 28 ? 0.03 : 0;
    const dept = state.flags.routedToDevDept;
    const deptBonus = (dept==="data" || dept==="arch") ? 0.02 : 0;
    const p = (e.chance || 0) + bonus + deptBonus;
    if (Math.random() < p){
      applyDelta(e.delta);
      if (c >= 55) setGlitch(true);
      return e;
    }
  }
  return null;
}

function renderProgress(){
  el.stepsMax.textContent = story.meta.maxSteps;
  el.stepsNow.textContent = state.steps;
  el.dots.innerHTML = "";
  for (let i=1;i<=story.meta.maxSteps;i++){
    const d = document.createElement("div");
    d.className = "p";
    if (i <= state.steps) d.classList.add("on");
    if (creepScore() >= 55 && i === state.steps) d.classList.add("bad");
    el.dots.appendChild(d);
  }
}

function updateTopPills(){
  el.stRole.textContent = state.role;
  el.stDay.textContent = state.day;
  el.stBudget.textContent = state.budget;
  el.stStress.textContent = state.stress;
  el.stScope.textContent = state.scope;
  el.stFocus.textContent = state.focus;

  const pillDots = [
    [el.pillRole, state.role === "—" ? "warn" : "ok"],
    [el.pillDay, "ok"],
    [el.pillBudget, state.budget >= 40 ? "ok" : state.budget >= 15 ? "warn" : "bad"],
    [el.pillStress, state.stress <= 6 ? "ok" : state.stress <= 12 ? "warn" : "bad"],
    [el.pillScope, state.scope <= 3 ? "ok" : state.scope <= 6 ? "warn" : "bad"],
  ];
  for (const [pill, lvl] of pillDots){
    const d = pill.querySelector(".dot");
    d.className = "dot " + (lvl==="ok" ? "ok" : lvl==="warn" ? "warn" : "bad");
  }

  const c = creepScore();
  el.creepBar.style.width = c + "%";
  if (c < 28){ el.creepLabel.textContent = "спокоен"; el.creepHint.textContent = "Пока границы держатся."; }
  else if (c < 55){ el.creepLabel.textContent = "шевелится"; el.creepHint.textContent = "Скоуп тихо ищет лазейки."; }
  else { el.creepLabel.textContent = "проснулся"; el.creepHint.textContent = "Срочные сюрпризы и возвраты учащаются."; }

  el.riskVal.textContent = labelRisk()[0];
  el.repVal.textContent = labelRep();
  el.deptHint.textContent = deptHuman();
}

/** -------- Save / Load -------- */
function saveGame(){
  const payload = {
    v: 2,
    state,
    currentId,
    history,
    logHtml: el.log.innerHTML,
    settings: { audio: el.audioToggle.checked, type: el.typeToggle.checked }
  };
  localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
}
function hasSave(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return false;
    const obj = JSON.parse(raw);
    return !!obj && obj.v === 2;
  } catch { return false; }
}
function loadGame(){
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return false;
  try{
    const obj = JSON.parse(raw);
    if (!obj || obj.v !== 2) return false;
    state = obj.state;
    currentId = obj.currentId;
    history = obj.history || [];
    el.log.innerHTML = obj.logHtml || "";
    if (obj.settings){
      el.audioToggle.checked = !!obj.settings.audio;
      el.typeToggle.checked = !!obj.settings.type;
      el.audioToggle2.checked = !!obj.settings.audio;
      el.typeToggle2.checked = !!obj.settings.type;
    }
    return true;
  } catch { return false; }
}
function resetSave(){ localStorage.removeItem(SAVE_KEY); }

/** -------- Log -------- */
function pushLog(choiceLabel){
  const node = story.nodes[currentId];
  const div = document.createElement("div");
  div.className = "log-item";
  div.innerHTML = `<div><b>${escapeHtml(node?.title ?? currentId)}</b></div><div class="t">→ ${escapeHtml(choiceLabel)}</div>`;
  el.log.prepend(div);
}

/** -------- Quiz engine -------- */
function quizInit(node){
  state.quiz.active = true;
  state.quiz.q = 0;
  state.quiz.score = 0;
  state.quiz.total = node.quiz.total || (node.quiz.questions?.length || 0);
  state.quiz.onPassNext = node.quiz.onPassNext || "";
  state.quiz.onFailNext = node.quiz.onFailNext || "";
}
function quizPick(qIndex, optIndex, node){
  const q = node.quiz.questions[qIndex];
  const opt = q.options[optIndex];
  state.quiz.score += num(opt.score);
  state.quiz.q = qIndex + 1;
}
function quizNextNode(){
  if (!state.quiz.active) return null;
  if (state.quiz.q >= state.quiz.total){
    const passed = state.quiz.score >= 2; // из 3
    const next = passed ? state.quiz.onPassNext : state.quiz.onFailNext;
    state.quiz.active = false;
    return next;
  }
  if (state.quiz.q === 1) return "techcom_q2";
  if (state.quiz.q === 2) return "techcom_q3";
  return null;
}

/** -------- Render -------- */
function renderNode(){
  const node = story.nodes[currentId];
  if (!node){
    el.nodeTitle.textContent = "Ошибка";
    el.nodeMeta.textContent = "";
    el.nodeBadge.textContent = "";
    typeText(`Не найден узел: ${currentId}`);
    el.choices.innerHTML = "";
    el.whisper.hidden = true;
    return;
  }

  el.title.textContent = story.meta.title || "Игра";
  el.sub.textContent = story.meta.subtitle || "";
  el.nodeTitle.textContent = node.title || "";
  el.nodeBadge.textContent = node.chapter != null ? ("Глава " + node.chapter) : "—";

  const dept = state.flags.routedToDevDept || "—";
  el.nodeMeta.textContent = `роль: ${state.role} · dept: ${dept} · шаги: ${state.steps}/${story.meta.maxSteps}`;

  if (node.quiz && !state.quiz.active) quizInit(node);

  typeText(node.text || "");

  el.choices.innerHTML = "";
  if (node.ending){
    const b = document.createElement("button");
    b.className = "choice";
    b.innerHTML = `Сыграть ещё раз<div class="choice-meta"><span class="tag ok">restart</span></div>`;
    b.addEventListener("click", newMission);
    el.choices.appendChild(b);
  } else {
    const visibleChoices = (node.choices || []).filter(ch => meetsReq(ch.req));
    for (const ch of visibleChoices){
      const b = document.createElement("button");
      b.className = "choice";

      const tags = [];
      if (ch.delta){
        if (ch.delta.stress > 0) tags.push(`<span class="tag bad">+стресс</span>`);
        if (ch.delta.stress < 0) tags.push(`<span class="tag ok">-стресс</span>`);
        if (ch.delta.scope > 0) tags.push(`<span class="tag warn">+скоуп</span>`);
        if (ch.delta.budget < 0) tags.push(`<span class="tag warn">-бюджет</span>`);
        if (ch.delta.rep > 0) tags.push(`<span class="tag ok">+репутация</span>`);
        if (ch.delta.focus < 0) tags.push(`<span class="tag warn">-фокус</span>`);
      }
      if (ch.req?.repMin != null || ch.req?.focusMin != null || ch.req?.roleIs || ch.req?.deptIs) tags.push(`<span class="tag">условие</span>`);
      if (ch.setDept) tags.push(`<span class="tag">dept</span>`);
      if (ch.quizPick) tags.push(`<span class="tag">ответ</span>`);

      b.innerHTML = `${escapeHtml(ch.label)}<div class="choice-meta">${tags.join(" ")}</div>`;
      b.addEventListener("click", () => choose(ch));
      el.choices.appendChild(b);
    }
  }

  updateTopPills();
  renderProgress();
  maybeWhisper();

  el.back.disabled = history.length === 0;
  saveGame();
}

function choose(choice){
  history.push({ prevId: currentId, prevState: structuredClone(state), prevLog: el.log.innerHTML });

  Audio.click();
  state.steps = clamp(state.steps + 1, 0, story.meta.maxSteps);

  applyDelta(choice.delta);
  setFlags(choice.setFlags);
  if (choice.setRole) setRole(choice.setRole);
  if (choice.setDept) setDept(choice.setDept);

  const node = story.nodes[currentId];
  if (choice.quizPick && node?.quiz){
    quizPick(choice.quizPick.qIndex, choice.quizPick.optIndex, node);
  }

  let nextId = choice.next;

  if (nextId === "techcom_answer"){
    const nextQuiz = quizNextNode();
    el.whisper.textContent = `Техком: счёт ${state.quiz.score}/${state.quiz.total}`;
    el.whisper.hidden = false;
    nextId = nextQuiz || "techcom_fail";
  }
  if (nextId === "techcom_next"){
    nextId = quizNextNode() || "techcom_fail";
  }

  currentId = nextId;
  const ev = maybeRandomEvent();
  if (ev){
    el.whisper.textContent = "Событие: " + ev.text;
    el.whisper.hidden = false;
    if (creepScore() >= 55) { setGlitch(true); Audio.bad(); }
    else Audio.good();
  }

  if (creepScore() >= 60) setGlitch(true);
  pushLog(choice.label);

  renderNode();
}

function newMission(){
  stopTyping();
  state = structuredClone(story.initialState);
  currentId = "prologue";
  history = [];
  el.log.innerHTML = "";
  renderNode();
}
function continueMission(){
  stopTyping();
  if (!loadGame()){
    newMission();
    return;
  }
  renderNode();
}
function back(){
  stopTyping();
  if (!history.length) return;
  const last = history.pop();
  currentId = last.prevId;
  state = last.prevState;
  el.log.innerHTML = last.prevLog || el.log.innerHTML;
  Audio.click();
  renderNode();
}

/** UI actions */
el.restart.addEventListener("click", () => { el.overlay.style.display = "flex"; });
el.continueBtn.addEventListener("click", () => { el.overlay.style.display = "flex"; });
el.back.addEventListener("click", back);
el.skip.addEventListener("click", () => {
  if (!typing.running) return;
  stopTyping();
  el.nodeText.textContent = typing.fullText;
});

// sync toggles between overlay and panel
function syncToggles(fromOverlay=false){
  if (fromOverlay){
    el.audioToggle.checked = el.audioToggle2.checked;
    el.typeToggle.checked = el.typeToggle2.checked;
  } else {
    el.audioToggle2.checked = el.audioToggle.checked;
    el.typeToggle2.checked = el.typeToggle.checked;
  }
  saveGame();
}
el.audioToggle.addEventListener("change", ()=>syncToggles(false));
el.typeToggle.addEventListener("change", ()=>syncToggles(false));
el.audioToggle2.addEventListener("change", ()=>syncToggles(true));
el.typeToggle2.addEventListener("change", ()=>syncToggles(true));

el.btnNew.addEventListener("click", () => {
  syncToggles(true);
  el.overlay.style.display = "none";
  newMission();
});
el.btnContinue.addEventListener("click", () => {
  syncToggles(true);
  el.overlay.style.display = "none";
  continueMission();
});
el.btnResetSave.addEventListener("click", () => {
  resetSave();
  el.btnContinue.textContent = "Продолжить (нет сохранения)";
  el.btnContinue.disabled = true;
  el.continueBtn.disabled = true;
  Audio.bad();
});

// warm up audio context
document.addEventListener("click", () => { if (el.audioToggle.checked) Audio.click(); }, { once:true });

/** boot */
(function boot(){
  const ok = hasSave();
  el.btnContinue.disabled = !ok;
  el.btnContinue.textContent = ok ? "Продолжить" : "Продолжить (нет сохранения)";
  el.continueBtn.disabled = !ok;

  currentId = "prologue";
  renderNode();
})();
</script>
</body>
</html>
